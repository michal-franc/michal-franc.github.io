<!DOCTYPE html>
<html>
    <head>

    
    <meta name="robots" content="noindex">
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Michal Franc">
    <meta name="keywords" content="michal franc,leader,programmer,coach,speaker">
	<title>Everything you wanted to know about Sorting in .NET part 5 | Michal Franc</title>
	<meta name="description" content="  Contents">

    <link href="https://fonts.googleapis.com/css?family=Inconsolata:700|Raleway" rel="stylesheet">
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <link rel="author" href="https://plus.google.com/104238159697387202725?rel=author">

	<link rel="canonical" href="http://www.mfranc.com/blog/net-sorting-part5/">

    <link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" type="text/css" href="/css/sm.css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Michal Franc | Feed" href="http://feeds.feedburner.com/PassionateProgram">

    <meta property="og:locale" content="en_US">
    <meta property="og:title" content="Everything you wanted to know about Sorting in .NET part 5 | Michal Franc">
    <meta property="og:description" content="  Contents">
	<meta property="og:url" content="http://www.mfranc.com/blog/net-sorting-part5/">
    <meta property="og:site_name" content="Michal Franc Blog">
    <meta property="og:type" content="website">
	<meta property="og:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

	<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Everything you wanted to know about Sorting in .NET part 5 | Michal Franc">
    <meta name="twitter:site" content="@francmichal">
    <meta name="twitter:creator" content="@francmichal">
    <meta name="twitter:description" content="  Contents">
	<meta name="twitter:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15894596-3', 'auto');
  ga('send', 'pageview');
</script>

    <script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100563098); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100563098ns.gif" /></p></noscript>

    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1817837425153843'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1817837425153843&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


  </head>


  <body>
    <main>
      <header class="site-header">
  <div class="container">
	  <h1><a href="/">Michal<span>Franc</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/blog" title="Posts">Posts</a></li>
        
          <li><a href="/notes" title="Notes">Notes</a></li>
        
          <li><a href="/articles" title="Articles">Articles</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">Everything you wanted to know about Sorting in .NET part 5</h1>
      <p class="post-meta">Apr 1, 2018 • Michal Franc - 
		<small>
			<i class="icon icon-comments"></i><span class="disqus-comment-count" data-disqus-url="http://mfranc.com/blog/net-sorting-part5/"></span>
		</small>
		<small>
			
			<a class="tag-badge" href="/blog/tags/#algorithms">algorithms</a>
			
		</small>
	  </p>
    </header>

	<center>
		
	</center>

    <div class="post-content">
      
        






<div class="seriesNote">
    This article is <strong>Part 6</strong> in a <strong>7-Part</strong> Series.
    <ul>
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
      
        
          
              
              <li>Part 1 - 
              
                  <a href="/blog/net-sorting-intro/">Journey through the internals of .NET Sort</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 2 - 
              
                  <a href="/blog/net-sorting-part1/">Everything you wanted to know about Sorting in .NET - part I</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 3 - 
              
                  <a href="/blog/net-sorting-part3/">Everything you wanted to know about Sorting in .NET part 3</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 4 - 
              
                  <a href="/blog/net-sorting-part2/">Everything you wanted to know about Sorting in .NET part 2</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 5 - 
              
                  <a href="/blog/net-sorting-part6/">Everything you wanted to know about Sorting in .NET part 6</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 6 - 
              
                  This Article
              
              </li>
          
        
      
        
          
              
              <li>Part 7 - 
              
                  <a href="/blog/net-sorting-part4/">Everything you wanted to know about Sorting in .NET part 4</a>
              
              </li>
          
        
      
    
    </ul>
</div>




      
      <div class="toc">
  <h2>Contents</h2>
<ol id="markdown-toc">
  <li><a href="#why-fcall-is-special" id="markdown-toc-why-fcall-is-special">Why FCall is special</a>    <ol>
      <li><a href="#what-is-a-stub" id="markdown-toc-what-is-a-stub">What is a stub</a></li>
      <li><a href="#what-is-a-frame" id="markdown-toc-what-is-a-frame">What is a frame</a></li>
    </ol>
  </li>
</ol>

</div>

<p>In the last post we have discovered what are <code class="highlighter-rouge">calling conventions</code> and how does code operate on the machine code level. With this knowledge we can finally wrap up and finish discussing <code class="highlighter-rouge">FCall</code>.</p>

<h2 id="why-fcall-is-special">Why FCall is special</h2>

<p>The answer to that question can be found in <code class="highlighter-rouge">CoreClr</code> <sup id="fnref:fcall-coreclr"><a href="#fn:fcall-coreclr" class="footnote">1</a></sup></p>

<blockquote>
  <p>An <code class="highlighter-rouge">FCall</code> target uses <code class="highlighter-rouge">__fastcall</code> or some other calling convention to match the IL calling convention exactly. Thus, a call to FCall is a direct call to the target without no intervening stub or frames.</p>
</blockquote>

<p>We already discussed <code class="highlighter-rouge">__fastcall</code> which uses registers to pass arguments (first 2). It is a bit faster compared to other conventions like <code class="highlighter-rouge">JIT calling convention</code>. This one uses stack to pass arguments and return values. Stack operations use precious <code class="highlighter-rouge">cpu cycles</code> for setup and cleanup. It is a <code class="highlighter-rouge">micro-optimisation</code> and I don’t have any benchmarks but <code class="highlighter-rouge">__fastcall</code> should faster.  <sup id="fnref:sscli-book"><a href="#fn:sscli-book" class="footnote">2</a></sup><sup id="fnref:ssess-book"><a href="#fn:ssess-book" class="footnote">3</a></sup></p>

<p><code class="highlighter-rouge">FCall</code> is a direct call and no <code class="highlighter-rouge">stubs</code> or <code class="highlighter-rouge">frames</code> are interviening with it. When it comes to optimization and cpu cycles <code class="highlighter-rouge">the less is more</code>, but we need to discuss <code class="highlighter-rouge">stubs</code> and <code class="highlighter-rouge">frames</code> briefly.</p>

<h3 id="what-is-a-stub">What is a stub</h3>

<p>The first thing that comes to my mind in relation to <code class="highlighter-rouge">stub</code> is <code class="highlighter-rouge">Unit Test</code>. Simple objects used to control the context of <code class="highlighter-rouge">Unit</code> under test. <code class="highlighter-rouge">Stubs</code> in the <code class="highlighter-rouge">CLR</code> are completetly different. In <code class="highlighter-rouge">CLR</code> world stub is a small helper code. There are many stubs used for different reasons.</p>

<p>For instance <code class="highlighter-rouge">prestub</code> is used in <code class="highlighter-rouge">Just in time compilation</code> process. When <code class="highlighter-rouge">C#</code> code is compiled, every method changes to <code class="highlighter-rouge">IL</code> and is kept in <code class="highlighter-rouge">DLL</code> or <code class="highlighter-rouge">EXE</code> file. You can’t run <code class="highlighter-rouge">IL</code> straight away, it is not machine code. It has to be compiled once again by the <code class="highlighter-rouge">runtime</code>. When you start your program it starts main <code class="highlighter-rouge">Thread</code> and loads up <code class="highlighter-rouge">Execution Engine</code>. The first function to run is your <code class="highlighter-rouge">Main</code> function. It is kept along with other functions in your <code class="highlighter-rouge">EXE</code> file in a big table containing functions names, functions descriptions, metadatada, IL code and prestub. Il code cannot be the entrypoint as it is not yet a machine code - but <code class="highlighter-rouge">prestub</code> is and it serves as a main entrypoint.</p>

<p><code class="highlighter-rouge">prestub</code> contains machine code that calls runtime and orders it to <code class="highlighter-rouge">compile</code> it. Runtime takes the IL code compiles it and cleverly injects into the same memory address, replacing <code class="highlighter-rouge">prestub</code> with actual machine code. This process repeats itself and when Main function calls another function it again calls a <code class="highlighter-rouge">prestub</code> which tells the runtime to <code class="highlighter-rouge">compile it</code>. Proceess is repeated all the time and that is how <code class="highlighter-rouge">Just In Time</code> compilation is achieved. This is a very basic description of whole process as there is a JIT caching layer which helps to overcome some <code class="highlighter-rouge">JIT</code> overhead as it uses cpu cycles obviously. There are tools like NGEN that lets up compile aall the stubs and generate machine code for all the methods (use it only when you know what to do - JIT should be used in most of the scenarions)  <sup id="fnref:pre-stub-book"><a href="#fn:pre-stub-book" class="footnote">4</a></sup></p>

<p>There are more stubs in the <abbr title="Common Language Runtime">CLR</abbr> and this are used in different scenarions like:</p>

<ul>
  <li>implementation of generics and dynamic code</li>
  <li>marshalling in <code class="highlighter-rouge">P/Invoke</code></li>
  <li>security checks</li>
  <li>exception handling</li>
  <li>support for multiple calling conventions</li>
  <li><code class="highlighter-rouge">legacy</code> code adapters</li>
</ul>

<h3 id="what-is-a-frame">What is a frame</h3>

<p>In the <code class="highlighter-rouge">OSI model</code> frame is a data structure holding a <code class="highlighter-rouge">packet</code>.</p>

<p><img width="600px" class="img-center" src="/images/network-frame.png" alt="network-frame-img" /></p>

<p>In <code class="highlighter-rouge">CLR</code> it is used in</p>

<ul>
  <li>stack frame - part of stack that holds functions arguments, local variables, return values etc</li>
  <li>exception handler frame - used for exception handling</li>
  <li>execution engine frame - act like a runtime marker in SScli book <sup id="fnref:sscli-book:1"><a href="#fn:sscli-book" class="footnote">2</a></sup> they use <code class="highlighter-rouge">bookkeeping</code> to describe its usefullness..</li>
</ul>

<blockquote>
  <p>Execution engine frame</p>

  <ul>
    <li>Track and update stack-stored object references for garbage collection</li>
    <li>Hold state for security checks</li>
    <li>Recognize transitions, such as cross-domain or managed-to-unmanaged calls</li>
    <li>Find the correct handler and unwind the stack during an exception</li>
    <li>Generate human-readable call traces for debugger and exception support</li>
    <li>Keep track of exception resources</li>
  </ul>
</blockquote>

<p><code class="highlighter-rouge">frames</code> - stack is filled with <code class="highlighter-rouge">frames</code>. When a method is called a new frame is erected and it contains informations about <code class="highlighter-rouge">params</code>, <code class="highlighter-rouge">variables</code> and many other thingss.</p>

<p>FCALL benefits - functions implemented within Exceution Enginer and no need marshalling stubs.</p>

<p>With <code class="highlighter-rouge">FCall</code> there is not <code class="highlighter-rouge">pre stub</code> and the native code is not JIT compiled.</p>

<p>Example:
tak samo jak np wyjatek w c++ jest zrozumialy w c#
using frames</p>

<p>albo jak wywolac garbage collector z niezarzadzanego kodu ( uzywa sie stosu i specjalnym ramek ktore koduja informacje ze hej wywolaj garbage collector :smile: ) (edited)</p>

<p>??</p>

<p>Frames are needed to be able to read the <code class="highlighter-rouge">stack</code> supporting many different features like multiple calling conventions. It is a mechanism to  <sup id="fnref:sscli-book:2"><a href="#fn:sscli-book" class="footnote">2</a></sup></p>

<p>Beacuse bby default there is no need for <code class="highlighter-rouge">frames</code> or <code class="highlighter-rouge">stubs</code> and <code class="highlighter-rouge">FCall</code> entry pint is directly calledd this method is faster. You have to create frames for scenarios like <code class="highlighter-rouge">throwing exception</code> or calling <code class="highlighter-rouge">garbage collection</code> in <code class="highlighter-rouge">FCall</code>.</p>

<p>In <code class="highlighter-rouge">QCall</code> and <code class="highlighter-rouge">P/Invoke</code> frames and marshalling stubs are genereted automatically. This is a hit to the performance but it provides features that can help write safer code. Also if you use <code class="highlighter-rouge">FCall</code> and need to throw <code class="highlighter-rouge">Exception</code> or call <code class="highlighter-rouge">Garbage Collection</code> you need to ceate a <code class="highlighter-rouge">frame</code> - <code class="highlighter-rouge">frame is required</code> to pass information to the runtime that you want to do this operation??</p>

<p>Different language also represent types differently in the memory that I why you need marshaling stub to translate between two worlds.</p>

<p>What is the IL calling convention. how does it’s look like in the visual studio dism. That is why fcimpl and fcall is great, it matches convention to the one’s use by il and that I generate by jitter to remove intermediary step like marshaling stub. 
(frame has to provide something with GC and exceptions asm code in cpp exception looks different than the exception in il, runtime wouldnt be able to understand exception thrown in cpp without this translational step) frame I encoding state in one context it is then use im different context to rebuild it. Stack frame is like a meta data conteact.</p>

<div class="footnotes">
  <ol>
    <li id="fn:fcall-coreclr">
      <p><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/fcall.h#L176">fcall.h dotnet/coreclr</a> <a href="#fnref:fcall-coreclr" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:sscli-book">
      <p><a href="http://www.newardassociates.com/files/SSCLI2.pdf">Share Source CLI 2.0 Internals</a> <a href="#fnref:sscli-book" class="reversefootnote">&#8617;</a> <a href="#fnref:sscli-book:1" class="reversefootnote">&#8617;<sup>2</sup></a> <a href="#fnref:sscli-book:2" class="reversefootnote">&#8617;<sup>3</sup></a></p>
    </li>
    <li id="fn:ssess-book">
      <p><a href="https://books.google.co.uk/books?id=XibbpjWeRlMC&amp;pg=PA156&amp;lpg=PA156&amp;dq=JIT+calling+convention&amp;source=bl&amp;ots=33wM50sGqh&amp;sig=k3NQH4yu763HtT9gicujX3Xu_6s&amp;hl=en&amp;sa=X&amp;ved=0ahUKEwiL9J_Q2JLbAhVKKcAKHcWXB-gQ6AEINTAC#v=onepage&amp;q=JIT%20calling%20convention&amp;f=false">Shared Sources CLI Essentials</a> <a href="#fnref:ssess-book" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:pre-stub-book">
      <p><a href="https://books.google.co.uk/books?id=Rh2cAgAAQBAJ&amp;pg=PA16&amp;lpg=PA16&amp;dq=machine+code+stub&amp;source=bl&amp;ots=wlcIrlaI0J&amp;sig=H31EUvLkUX3_UHkh2DhjxghnB8w&amp;hl=en&amp;sa=X&amp;ved=0ahUKEwiY99PLv5LbAhVLJMAKHdu_DEYQ6AEIUDAE#v=onepage&amp;q=machine%20code%20stub&amp;f=false">.NET Components by Juval Lowy</a> <a href="#fnref:pre-stub-book" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>


      <span id="post-end"></span>
    </div>

    <div id="mc_embed_signup">
<form action="https://mfranc.us13.list-manage.com/subscribe/post?u=8a5865e28c59044d419ecbe95&amp;id=d545f31150" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL">If you are interested in Cloud Native, Scalability, System Design and more meaty side of Engineering at Scale. Then subscribe to my mailing list.</label>
      <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8a5865e28c59044d419ecbe95_d545f31150" tabindex="-1" value=""></div>
        <div class="clear">
          <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
        </div>
    </div>
</form>
</div>



    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
    <script>
      (function() {
        var d = document,
        s = d.createElement('script');
        s.src = '//thesilenceofthelams.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</aside>



  </div>

</article>

      </div>


      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="http://github.com/michal-franc" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="http://twitter.com/francmichal" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="http://facebook.com/michalfrancblog" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="https://uk.linkedin.com/in/michalfranc1" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>

    <p class="txt-medium-gray">
      <small>&copy;2018 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.slick-modals.js"/></script>

	  <!-- <script id="ulp-remote" src="http://tools.mfranc.com/wp-content/plugins/layered-popups/js/remote.min.js?ver=5.89" data-handler="http://tools.mfranc.com/wp-admin/admin-ajax.php"></script>
	  <script>

		    (function ($) {
			"use strict";
			var objectPositionTop = $('#post-end').offset().top - window.innerHeight;

				ulp_add_event("onexit", {
					popup:		"4AXWiVSrZD71uqiP",
					mode:		"once-period",
					period:		30
				});

				ulp_add_event("onidle", {
					popup:		"85oltSbndJGZQzaW",
					mode:		"once-period",
					period:         30
				});

				ulp_add_event("onscroll", {
					popup:		"INyhHrwTzxjvcqEb",
					mode:		"once-period",
					period:         30,
					offset:		objectPositionTop / 2
				});

		    }(jQuery));

    </script> -->

		<script id="dsq-count-scr" src="//thesilenceofthelams.disqus.com/count.js" async></script>

		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.7&appId=125980610784627";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
    </main>
  </body>
</html>
