<!DOCTYPE html>
<html>
    <head>

    
    <meta name="robots" content="noindex">
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Michal Franc">
    <meta name="keywords" content="michal franc,leader,programmer,coach,speaker">
	<title>Everything you wanted to know about Sorting in .NET - part I | Michal Franc</title>
	<meta name="description" content="  Contents">

    <link href="https://fonts.googleapis.com/css?family=Inconsolata:700|Raleway" rel="stylesheet">
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <link rel="author" href="https://plus.google.com/104238159697387202725?rel=author">

	<link rel="canonical" href="http://www.mfranc.com/blog/net-sorting-part1/">

    <link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" type="text/css" href="/css/sm.css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Michal Franc | Feed" href="http://feeds.feedburner.com/PassionateProgram">

    <meta property="og:locale" content="en_US">
    <meta property="og:title" content="Everything you wanted to know about Sorting in .NET - part I | Michal Franc">
    <meta property="og:description" content="  Contents">
	<meta property="og:url" content="http://www.mfranc.com/blog/net-sorting-part1/">
    <meta property="og:site_name" content="Michal Franc Blog">
    <meta property="og:type" content="website">
	<meta property="og:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

	<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Everything you wanted to know about Sorting in .NET - part I | Michal Franc">
    <meta name="twitter:site" content="@francmichal">
    <meta name="twitter:creator" content="@francmichal">
    <meta name="twitter:description" content="  Contents">
	<meta name="twitter:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15894596-3', 'auto');
  ga('send', 'pageview');
</script>

    <script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100563098); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100563098ns.gif" /></p></noscript>

    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1817837425153843'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1817837425153843&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


  </head>


  <body>
    <main>
      <header class="site-header">
  <div class="container">
	  <h1><a href="/">Michal<span>Franc</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/blog" title="Posts">Posts</a></li>
        
          <li><a href="/notes" title="Notes">Notes</a></li>
        
          <li><a href="/articles" title="Articles">Articles</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">Everything you wanted to know about Sorting in .NET - part I</h1>
      <p class="post-meta">Apr 1, 2018 • Michal Franc - 
		<small>
			<i class="icon icon-comments"></i><span class="disqus-comment-count" data-disqus-url="http://mfranc.com/blog/net-sorting-part1/"></span>
		</small>
		<small>
			
			<a class="tag-badge" href="/blog/tags/#algorithms">algorithms</a>
			
		</small>
	  </p>
    </header>

	<center>
		
	</center>

    <div class="post-content">
      
        






<div class="seriesNote">
    This article is <strong>Part 2</strong> in a <strong>7-Part</strong> Series.
    <ul>
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
      
        
          
              
              <li>Part 1 - 
              
                  <a href="/blog/net-sorting-intro/">Journey through the internals of .NET Sort</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 2 - 
              
                  This Article
              
              </li>
          
        
      
        
          
              
              <li>Part 3 - 
              
                  <a href="/blog/net-sorting-part3/">Everything you wanted to know about Sorting in .NET part 3</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 4 - 
              
                  <a href="/blog/net-sorting-part2/">Everything you wanted to know about Sorting in .NET part 2</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 5 - 
              
                  <a href="/blog/net-sorting-part6/">Everything you wanted to know about Sorting in .NET part 6</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 6 - 
              
                  <a href="/blog/net-sorting-part5/">Everything you wanted to know about Sorting in .NET part 5</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 7 - 
              
                  <a href="/blog/net-sorting-part4/">Everything you wanted to know about Sorting in .NET part 4</a>
              
              </li>
          
        
      
    
    </ul>
</div>




      
      <div class="toc">
  <h2>Contents</h2>
<ol id="markdown-toc">
  <li><a href="#listtsort" id="markdown-toc-listtsort">List&lt;T&gt;.Sort()</a></li>
  <li><a href="#version" id="markdown-toc-version">_version++</a></li>
  <li><a href="#why-state-protection-is-important-during-enumeration" id="markdown-toc-why-state-protection-is-important-during-enumeration">Why state protection is important during enumeration?</a></li>
</ol>

</div>

<p>If we want to talk about sorting in <code class="highlighter-rouge">.NET</code>, then there is no better place to start than <code class="highlighter-rouge">List&lt;T&gt;.Sort()</code>. We all know what this functions does. As a Junior, I have never bothered to actually check the source code of this function. Back then source was only available to <code class="highlighter-rouge">insiders</code>, a handfull of special people for <code class="highlighter-rouge">Microsoft</code>, considered worthy to look behind the curtain. I still remember times of Steve B. and his firm stand against <code class="highlighter-rouge">Open Source</code>. This days are gone, <code class="highlighter-rouge">Microsoft</code> did a massive <code class="highlighter-rouge">U-turn</code> and not only <code class="highlighter-rouge">Reference Source</code><sup id="fnref:reference-source-link"><a href="#fn:reference-source-link" class="footnote">1</a></sup> is available but also <code class="highlighter-rouge">CLR</code><sup id="fnref:clr-source"><a href="#fn:clr-source" class="footnote">2</a></sup> code.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IList</span><span class="p">,</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">_defaultCapacity</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">T</span><span class="p">[]</span> <span class="n">_items</span><span class="p">;</span>
    <span class="p">[</span><span class="nf">ContractPublicPropertyName</span><span class="p">(</span><span class="s">"Count"</span><span class="p">)]</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_size</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_version</span><span class="p">;</span>
    <span class="p">[</span><span class="n">NonSerialized</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">Object</span> <span class="n">_syncRoot</span><span class="p">;</span>
    <span class="p">...</span></code></pre>
</figure>

<p>This is just just a slice of the <code class="highlighter-rouge">List&lt;T&gt;</code> implementation. <code class="highlighter-rouge">Reference Source</code> is a great source of knowledge. You can read it and learn how to write software that is used by millions of people and thousands of <code class="highlighter-rouge">Engineers</code>. It is full of <code class="highlighter-rouge">good</code> practices that you can read and use in your own code.</p>

<p>For other communities <code class="highlighter-rouge">open source</code> is nothing special but for <code class="highlighter-rouge">.NET</code> that was  a massive change. This move could save <code class="highlighter-rouge">C#</code> and <code class="highlighter-rouge">.NET</code> … but there is no time now for this discussion.</p>

<h2 id="listtsort">List&lt;T&gt;.Sort()</h2>

<p>How do we sort a List? It is quite simple.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">9</span> <span class="p">,</span> <span class="m">1</span> <span class="p">};</span>
<span class="n">list</span><span class="p">.</span><span class="nf">Sort</span><span class="p">();</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

<span class="n">output</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">10</span><span class="p">]</span></code></pre>
</figure>

<p>There is also a function to sort only a slice of the list.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">9</span> <span class="p">,</span> <span class="m">1</span> <span class="p">};</span>
<span class="n">list</span><span class="p">.</span><span class="nf">Sort</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

<span class="n">output</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">1</span><span class="p">]</span></code></pre>
</figure>

<p>How does it look like in the <a href="https://referencesource.microsoft.com/#mscorlib/system/collections/generic/list.cs,2f4bb2904365726f">source code</a>?</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">void</span> <span class="nf">Sort</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">Sort</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">Count</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Sort</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Out Of Range exception  
</span>    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Out Of Range exception  
</span>    <span class="p">}</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">_size</span> <span class="p">-</span> <span class="n">index</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">)</span>
        <span class="c1">// Out Of Range exception  
</span>
    <span class="n">Contract</span><span class="p">.</span><span class="nf">EndContractBlock</span><span class="p">();</span>

    <span class="n">Array</span><span class="p">.</span><span class="n">Sort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">_items</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">comparer</span><span class="p">);</span>
    <span class="n">_version</span><span class="p">++;</span>
<span class="p">}</span></code></pre>
</figure>

<p>I removed <code class="highlighter-rouge">ThrowHelper</code> and replaced with commment to explain what it does and increase readability. It is interesting that there is a lack of consistency for<code class="highlighter-rouge">if</code> statements. First two are using <code class="highlighter-rouge"><span class="p">{}</span></code> and the third one is not.</p>

<p><code class="highlighter-rouge">Contract.EndContractBlock()</code> is part of <code class="highlighter-rouge">Code Contracts</code>. This is a framework to generate assertions that are used for instance by static analyzers to verify the correctnes of code. This is a evolution of <code class="highlighter-rouge">Assertions</code>, contracts are more powerfull and can be used to generate runtime checks, static checks and also to generate tests by using <code class="highlighter-rouge">Test Generation tools</code>.</p>

<p>Usually just like with <code class="highlighter-rouge">Assertions</code> you need to add snippets of code like:</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="n">Contract</span><span class="p">.</span><span class="nf">Requires</span><span class="p">(</span><span class="n">x</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></code></pre>
</figure>

<p><code class="highlighter-rouge">Contract.EndContractBlock()</code> is special as it wraps preceeding <code class="highlighter-rouge">if</code> statements and code conditions into the <code class="highlighter-rouge">Code Contract</code> semantics. It is very usefull when using legacy code as you just mark <code class="highlighter-rouge">CodeContract Block</code> that reuses existing code. There is not need to change anything.<sup id="fnref:code-contracts"><a href="#fn:code-contracts" class="footnote">3</a></sup></p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="n">Array</span><span class="p">.</span><span class="n">Sort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">_items</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">comparer</span><span class="p">);</span>
<span class="n">_version</span><span class="p">++;</span></code></pre>
</figure>

<p>The call is redirected to <code class="highlighter-rouge">Array.Sort&lt;T&gt;</code> function.</p>

<p>The parameters in this case are:</p>

<ul>
  <li><code class="highlighter-rouge">_items</code> -&gt; <code class="highlighter-rouge">T[]</code> internal representation of the list</li>
  <li><code class="highlighter-rouge">index</code> -&gt; <code class="highlighter-rouge">0</code> - start from the begining of the list</li>
  <li><code class="highlighter-rouge">Count</code> -&gt; <code class="highlighter-rouge">list</code> count -&gt; sort whole list</li>
  <li><code class="highlighter-rouge">comparer</code> -&gt; <code class="highlighter-rouge">null</code> -&gt; use default comparer</li>
</ul>

<p><code class="highlighter-rouge">_items</code> - Internally <code class="highlighter-rouge">List&lt;T&gt;</code> uses <code class="highlighter-rouge">array</code> to store values. <code class="highlighter-rouge">List</code> enriches f<code class="highlighter-rouge">Array</code> providing dynamic resizing, sorting, add with resize, remove  and other things.</p>

<p>Another interesting bit here is  <code class="highlighter-rouge">_version++</code> operation.</p>

<h2 id="version">_version++</h2>

<p><code class="highlighter-rouge">_version</code> is a integer value used to check if internal <code class="highlighter-rouge">State</code> of the <code class="highlighter-rouge">Array</code> has changed.</p>

<p>Operations ending with <code class="highlighter-rouge">_version++</code>:</p>

<ul>
  <li><code class="highlighter-rouge">Add</code>, <code class="highlighter-rouge">Remove</code>, <code class="highlighter-rouge">Clear</code>, <code class="highlighter-rouge">Insert</code>, <code class="highlighter-rouge">[]</code> using index to set</li>
  <li><code class="highlighter-rouge">Sort</code>, <code class="highlighter-rouge">Reverse</code> - changing order of items is considered as state change</li>
</ul>

<p>Why would this be usefull?</p>

<p>You are probably familiar with code like this:</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">8</span><span class="p">};</span>

<span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">l</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">list</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">output</span><span class="p">:</span>
<span class="m">1</span> 
<span class="n">InvalidOperationException</span><span class="p">:</span> <span class="n">Collection</span> <span class="n">was</span> <span class="n">modified</span><span class="p">;</span> <span class="n">enumeration</span> <span class="n">operation</span> <span class="n">may</span> <span class="n">not</span> <span class="n">execute</span></code></pre>
</figure>

<p>If you ever wondered how does the framework know when to throw that exception. You know the answer now. It uses <code class="highlighter-rouge">_version</code> to do that.</p>

<p>As <code class="highlighter-rouge">List</code> is a wrapper of array, if you change the state of array inside foreach there is no exception as there is not support for this <code class="highlighter-rouge">State</code> change protection during enumeration.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]{</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">};</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">int</span> <span class="n">item</span> <span class="k">in</span> <span class="n">array</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">array</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">output</span><span class="p">:</span>
<span class="m">1</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span></code></pre>
</figure>

<p>No exception here. Exception won’t also happen if <code class="highlighter-rouge">for</code> loop is used instead of <code class="highlighter-rouge">foreach</code>.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">8</span><span class="p">};</span>

<span class="kt">var</span> <span class="n">once</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">if</span><span class="p">(!</span><span class="n">once</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">list</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
    <span class="n">once</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">output</span><span class="p">:</span>
<span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">8</span></code></pre>
</figure>

<p>There is something special happening when you join bot <code class="highlighter-rouge">foreach</code> and <code class="highlighter-rouge">List</code>. This special thing is called <code class="highlighter-rouge">Enumerator</code>.</p>

<p><code class="highlighter-rouge">foreach</code> is just a syntactic sugar <sup id="fnref:foreach-internals"><a href="#fn:foreach-internals" class="footnote">4</a></sup>. We can use great tool called <a href="https://sharplab.io/">sharplab.io</a> to check how it is resolved by the compiler.</p>

<p>foreach on array <a href="https://sharplab.io/#v2:D4AQDABCCMDcCwAoEBmKAmK0AcEDeSERUaIALBAMoAuAhgE7UAUAlPocZx50QG4MQG9WgE8IAXggA7AKYB3CAEsp1ANoBdfBGgAaCOj0o9ZPQFY9ANggBfBIh7FuPAGYB7ejNoBjABZN+9EpKUoL0wiIsTpwE9g48AMKuUgDOrgA2MgB0AOr0itQyTIosdnE2TtZI1kA">sharp lab example</a></p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span> <span class="p">};</span>

<span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="k">in</span> <span class="n">array</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">changes</span> <span class="n">to</span><span class="p">:</span>

<span class="kt">int</span><span class="p">[]</span> <span class="n">obj</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="m">6</span><span class="p">];</span>
<span class="n">RuntimeHelpers</span><span class="p">.</span><span class="nf">InitializeArray</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">RuntimeFieldHandle</span><span class="p">)</span><span class="cm">/*OpCode not supported: LdMemberToken*/</span><span class="p">);</span>
<span class="kt">int</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">obj</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span></code></pre>
</figure>

<p>As you can see this is a simple <code class="highlighter-rouge">for loop</code>.</p>

<p>Ignore <code class="highlighter-rouge">OpCode not supported: LdMemberToken</code>. This is limitation of <code class="highlighter-rouge">decompilers</code> not being able to find <code class="highlighter-rouge">FieldHandle</code> this is a special object containing <code class="highlighter-rouge">metadata</code>. <code class="highlighter-rouge">RuntimeHelperss.InitializerArray</code> is a implementation detail of <code class="highlighter-rouge">new int[] { 1..6 }</code></p>

<p>When it comes to the <code class="highlighter-rouge">List</code> it looks <a href="https://sharplab.io/#v2:D4AQDABCCMDcCwAocVoBYGKSAzFATKgBwQDeSElUeIaEAygC4CGATowBQCUZFV/ffpQBubCABsAlgGdGEALwQAdgFMA7hAAyMxgB5JSxgD4yEaABoI+SzktpLAVksA2CAF9MQqoKEAzAPasKswAxgAWHKKsEJIxShI6XD785IheXgDC/krS/uIqAHQA6qySjCocklye6W4+dYhuQA===">differently</a></p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span> <span class="p">};</span>

<span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">changes</span> <span class="n">to</span><span class="p">:</span>

<span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
<span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
<span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
<span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
<span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="m">4</span><span class="p">);</span>
<span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
<span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="m">6</span><span class="p">);</span>
<span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;.</span><span class="n">Enumerator</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">();</span>
<span class="k">try</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">finally</span>
<span class="p">{</span>
    <span class="p">((</span><span class="n">IDisposable</span><span class="p">)</span><span class="n">enumerator</span><span class="p">).</span><span class="nf">Dispose</span><span class="p">();</span>
<span class="p">}</span></code></pre>
</figure>

<p>For loop is gone and replaced by <code class="highlighter-rouge">while</code> with <code class="highlighter-rouge">Enumerator</code>. In this post, I ll skip the <code class="highlighter-rouge">intro</code> to enumerators and enumeration. You can once again in this great article. <sup id="fnref:foreach-internals:1"><a href="#fn:foreach-internals" class="footnote">4</a></sup></p>

<p>I want to focus on <code class="highlighter-rouge">_version</code> value. When we check <code class="highlighter-rouge">list.GetEnumerator()</code> function.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">Enumerator</span> <span class="nf">GetEnumerator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Enumerator</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</figure>

<p>We can see that whole list is being used to instantiate a new object - <code class="highlighter-rouge">Enumerator</code>. In the constructor <code class="highlighter-rouge">Enumerator</code> keeps the copy of the <code class="highlighter-rouge">_version</code> value.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">internal</span> <span class="nf">Enumerator</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">list</span> <span class="p">=</span> <span class="n">list</span><span class="p">;</span>
    <span class="n">index</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">version</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">_version</span><span class="p">;</span>
    <span class="n">current</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</figure>

<p>This value is <code class="highlighter-rouge">private</code> and does not change in the whole life-time of the <code class="highlighter-rouge">Enumerator</code>. How is it used? If you look at decompiled code for foreach on the List, <code class="highlighter-rouge">MoveNext()</code> function is used to set <code class="highlighter-rouge">Current</code> value. Note that reference to the list is also kept.  Source code of this function looks like this.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="kt">bool</span> <span class="nf">MoveNext</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">localList</span> <span class="p">=</span> <span class="n">list</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="p">==</span> <span class="n">localList</span><span class="p">.</span><span class="n">_version</span> <span class="p">&amp;&amp;</span> <span class="p">((</span><span class="kt">uint</span><span class="p">)</span><span class="n">index</span> <span class="p">&lt;</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">localList</span><span class="p">.</span><span class="n">_size</span><span class="p">))</span> 
  <span class="p">{</span>                                                     
      <span class="n">current</span> <span class="p">=</span> <span class="n">localList</span><span class="p">.</span><span class="n">_items</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>                    
      <span class="n">index</span><span class="p">++;</span>
      <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nf">MoveNextRare</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="kt">bool</span> <span class="nf">MoveNextRare</span><span class="p">()</span>
<span class="p">{</span>                
    <span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="p">!=</span> <span class="n">list</span><span class="p">.</span><span class="n">_version</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ThrowHelper</span><span class="p">.</span><span class="nf">ThrowInvalidOperationException</span><span class="p">(</span><span class="n">ExceptionResource</span><span class="p">.</span><span class="n">InvalidOperation_EnumFailedVersion</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">index</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">_size</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">current</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>                
<span class="p">}</span></code></pre>
</figure>

<p>And here you go in the <code class="highlighter-rouge">MoveNextRare()</code> function there is a check if <code class="highlighter-rouge">original  version value</code> is the same as <code class="highlighter-rouge">current list version</code>. If list was modified during <code class="highlighter-rouge">Enumerator</code> life-cycle, exception will be thrown.</p>

<p>Tha part with:</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">index</span> <span class="p">&lt;</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">localList</span><span class="p">.</span><span class="n">_size</span><span class="p">)</span></code></pre>
</figure>

<p>Is to check if iteration reached the end of the list. In that case <code class="highlighter-rouge">MoveNext</code> returns false and <code class="highlighter-rouge">while</code> loop ends.</p>

<h2 id="why-state-protection-is-important-during-enumeration">Why state protection is important during enumeration?</h2>

<p>The idea of enumeration is to read stable collection of elements. When enumerating we want to vist every element on the collection only once and do some action on it. Alowing enumeration on a changing collection introduces problems like: possibility of visiting elements two times.</p>

<p>We can go back to previous example with <code class="highlighter-rouge">Insert</code> inside a for loop to the beggingin of the list.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">8</span><span class="p">};</span>

<span class="kt">var</span> <span class="n">once</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">if</span><span class="p">(!</span><span class="n">once</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">list</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
    <span class="n">once</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">output</span><span class="p">:</span>
<span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">8</span></code></pre>
</figure>

<p>There is no <code class="highlighter-rouge">10</code> but <code class="highlighter-rouge">1</code> twice. When <code class="highlighter-rouge">10</code> was added, <code class="highlighter-rouge">i</code> is 0 and will be <code class="highlighter-rouge">1</code> onext iteration. This means that element on the <code class="highlighter-rouge">0</code> index moves to <code class="highlighter-rouge">1</code> and is printed twice when i is <code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">1</code>.</p>

<p>Enumaration using foreach and <code class="highlighter-rouge">List</code> wrapping loginc of <code class="highlighter-rouge">_version</code> value is here to protect us from that kind of mistake. When <code class="highlighter-rouge">Enumerating</code> with <code class="highlighter-rouge">foreach</code> on a <code class="highlighter-rouge">List</code> you can assume that <code class="highlighter-rouge">List</code> won’t be changed. This frees you up from implementing more complicated application logic to handle this scenario. It is similar concept to using different types of collections, limiting posibilities and sendind a message to a fellow <code class="highlighter-rouge">developer</code> <code class="highlighter-rouge">Hey I am returning IEnumerable beacuase, I am expecting you to only enumerate this collection</code>.</p>

<p>Next part we will get more into the rabbit hole and explore <code class="highlighter-rouge">Array.Sort()</code> touching <code class="highlighter-rouge">TrySZSort</code> magic.</p>
<div class="footnotes">
  <ol>
    <li id="fn:reference-source-link">
      <p><a href="https://referencesource.microsoft.com">Reference Source Microsoft</a> <a href="#fnref:reference-source-link" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:clr-source">
      <p><a href="https://github.com/dotnet/coreclr">Github - coreclr</a> <a href="#fnref:clr-source" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:code-contracts">
      <p><a href="https://docs.microsoft.com/en-us/dotnet/framework/debug-trace-profile/code-contracts#usage_guidelines">Code Contracts</a> <a href="#fnref:code-contracts" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:foreach-internals">
      <p><a href="https://msdn.microsoft.com/en-us/magazine/mt797654.aspx">MSDN - Essential .NET Understanding C# foreach … </a> <a href="#fnref:foreach-internals" class="reversefootnote">&#8617;</a> <a href="#fnref:foreach-internals:1" class="reversefootnote">&#8617;<sup>2</sup></a></p>
    </li>
  </ol>
</div>


      <span id="post-end"></span>
    </div>

    <div id="mc_embed_signup">
<form action="https://mfranc.us13.list-manage.com/subscribe/post?u=8a5865e28c59044d419ecbe95&amp;id=d545f31150" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL">If you are interested in Cloud Native, Scalability, System Design and more meaty side of Engineering at Scale. Then subscribe to my mailing list.</label>
      <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8a5865e28c59044d419ecbe95_d545f31150" tabindex="-1" value=""></div>
        <div class="clear">
          <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
        </div>
    </div>
</form>
</div>



    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
    <script>
      (function() {
        var d = document,
        s = d.createElement('script');
        s.src = '//thesilenceofthelams.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</aside>



  </div>

</article>

      </div>


      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="http://github.com/michal-franc" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="http://twitter.com/francmichal" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="http://facebook.com/michalfrancblog" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="https://uk.linkedin.com/in/michalfranc1" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>

    <p class="txt-medium-gray">
      <small>&copy;2018 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.slick-modals.js"/></script>

	  <!-- <script id="ulp-remote" src="http://tools.mfranc.com/wp-content/plugins/layered-popups/js/remote.min.js?ver=5.89" data-handler="http://tools.mfranc.com/wp-admin/admin-ajax.php"></script>
	  <script>

		    (function ($) {
			"use strict";
			var objectPositionTop = $('#post-end').offset().top - window.innerHeight;

				ulp_add_event("onexit", {
					popup:		"4AXWiVSrZD71uqiP",
					mode:		"once-period",
					period:		30
				});

				ulp_add_event("onidle", {
					popup:		"85oltSbndJGZQzaW",
					mode:		"once-period",
					period:         30
				});

				ulp_add_event("onscroll", {
					popup:		"INyhHrwTzxjvcqEb",
					mode:		"once-period",
					period:         30,
					offset:		objectPositionTop / 2
				});

		    }(jQuery));

    </script> -->

		<script id="dsq-count-scr" src="//thesilenceofthelams.disqus.com/count.js" async></script>

		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.7&appId=125980610784627";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
    </main>
  </body>
</html>
