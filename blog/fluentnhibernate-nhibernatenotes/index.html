<!DOCTYPE html>
<html>
    <head>

    
    <meta name="robots" content="all">
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Michal Franc">
    <meta name="keywords" content="michal franc,leader,programmer,coach,speaker">
	<title>FluentNHibernate , NHibernate–Notes | Michal Franc</title>
	<meta name="description" content="I m currently implementing some project using the NHibernate. I dont like the mappongs stored in xml files so I am using FluentNhiberante.">

    <link href="https://fonts.googleapis.com/css?family=Inconsolata:700|Raleway" rel="stylesheet">
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <link rel="author" href="https://plus.google.com/104238159697387202725?rel=author">

	<link rel="canonical" href="http://www.mfranc.com/blog/fluentnhibernate-nhibernatenotes/">

    <link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" type="text/css" href="/css/sm.css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Michal Franc | Feed" href="http://feeds.feedburner.com/PassionateProgram">

    <meta property="og:locale" content="en_US">
    <meta property="og:title" content="FluentNHibernate , NHibernate–Notes | Michal Franc">
    <meta property="og:description" content="I m currently implementing some project using the NHibernate. I dont like the mappongs stored in xml files so I am using FluentNhiberante.">
	<meta property="og:url" content="http://www.mfranc.com/blog/fluentnhibernate-nhibernatenotes/">
    <meta property="og:site_name" content="Michal Franc Blog">
    <meta property="og:type" content="website">
	<meta property="og:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

	<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="FluentNHibernate , NHibernate–Notes | Michal Franc">
    <meta name="twitter:site" content="@francmichal">
    <meta name="twitter:creator" content="@francmichal">
    <meta name="twitter:description" content="I m currently implementing some project using the NHibernate. I dont like the mappongs stored in xml files so I am using FluentNhiberante.">
	<meta name="twitter:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15894596-3', 'auto');
  ga('send', 'pageview');
</script>

    <script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100563098); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100563098ns.gif" /></p></noscript>

    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1817837425153843'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1817837425153843&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


  </head>


  <body>
    <main>
      <header class="site-header">
  <div class="container">
	  <h1><a href="/">Michal<span>Franc</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/blog" title="Posts">Posts</a></li>
        
          <li><a href="/notes" title="Notes">Notes</a></li>
        
          <li><a href="/articles" title="Articles">Articles</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">FluentNHibernate , NHibernate–Notes</h1>
      <p class="post-meta">Mar 30, 2011 • Michal Franc - 
		<small>
			<i class="icon icon-comments"></i><span class="disqus-comment-count" data-disqus-url="http://mfranc.com/blog/fluentnhibernate-nhibernatenotes/"></span>
		</small>
		<small>
			
		</small>
	  </p>
    </header>

	<center>
		
	</center>

    <div class="post-content">
      
      <p align="justify">I m currently implementing some project using the NHibernate. I dont like the mappongs stored in xml files so I am using FluentNhiberante.</p>
<p align="justify"></p>

<h5 align="justify">1. Mapping Whole Assembly.</h5>
<p align="justify">Before discovering this feature , I created one line foreach mapping defined in the assembly. You can replace this “useless” code with the procedure to map whole assembly. FluentNH  will scan the assembly and look for classes inheriting from ClassMap&lt;&gt;</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"> <span class="k">return</span> <span class="n">Fluently</span><span class="p">.</span><span class="nf">Configure</span><span class="p">().</span>
    <span class="nf">Database</span><span class="p">(</span><span class="n">MsSqlConfiguration</span><span class="p">.</span><span class="n">MsSql2008</span><span class="p">.</span><span class="nf">ConnectionString</span><span class="p">(</span><span class="s">"connstring"</span><span class="p">))</span>
      <span class="p">.</span><span class="nf">Mappings</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">FluentMappings</span><span class="p">.</span><span class="nf">AddFromAssembly</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">()))</span>
      <span class="p">.</span><span class="nf">ExposeConfiguration</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">BuildSessionFactory</span><span class="p">();</span></code></pre>
</figure>

<p> </p>
<h5 align="justify">2. not null fields</h5>
<p align="justify">If you want to create some fields in the DB as “not null”. use the Not.Nullable() sequence.</p>

<p> </p>
<h5 align="justify">3. Reseting Schema for Testing</h5>
<p align="justify">I don’t know if this is a good approach but when , I am working with NH i create an instance of test database with sample data. Everytime , I am running tests i m reseting schema , filling DB with sample data and then database is erased from memory (SQLite) or the server.</p>
<p align="justify"><strong>Session Factory Class</strong></p>
<p align="justify">In my session factory Class i have methods to reset and update Schema</p>
<p align="justify"></p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"> <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SessionFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">ISession</span> <span class="nf">OpenSession</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">GetSessionFactory</span><span class="p">().</span><span class="nf">OpenSession</span><span class="p">();</span>
    <span class="p">}</span>
     <span class="k">private</span> <span class="k">static</span> <span class="n">ISessionFactory</span> <span class="nf">GetSessionFactory</span><span class="p">()</span>
     <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_sessionFactory</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_sessionFactory</span> <span class="p">=</span> <span class="nf">CreateSessionFactory</span><span class="p">(</span><span class="n">UpdateSchema</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">return</span> <span class="n">_sessionFactory</span><span class="p">;</span>
     <span class="p">}</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">ISessionFactory</span> <span class="n">_sessionFactory</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ResetSchema</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">CreateSessionFactory</span><span class="p">(</span><span class="n">ResetSchema</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="n">ISessionFactory</span> <span class="nf">CreateSessionFactory</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Configuration</span><span class="p">&gt;</span> <span class="n">func</span><span class="p">)</span>
        <span class="p">{</span>

          <span class="k">return</span> <span class="n">Fluently</span><span class="p">.</span><span class="nf">Configure</span><span class="p">().</span>
               <span class="nf">Database</span><span class="p">(</span><span class="n">MsSqlConfiguration</span><span class="p">.</span><span class="n">MsSql2008</span><span class="p">.</span><span class="nf">ConnectionString</span>
               <span class="p">(</span><span class="s">"connstring"</span><span class="p">))</span>
               <span class="p">.</span><span class="nf">Mappings</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">FluentMappings</span><span class="p">.</span><span class="nf">AddFromAssembly</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">()))</span>
               <span class="p">.</span><span class="nf">ExposeConfiguration</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">BuildSessionFactory</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">UpdateSchema</span><span class="p">(</span><span class="n">Configuration</span> <span class="n">config</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="nf">SchemaUpdate</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="nf">Execute</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ResetSchema</span><span class="p">(</span><span class="n">Configuration</span> <span class="n">config</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="nf">SchemaExport</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
        <span class="p">}</span></code></pre>
</figure>

<p> </p>
<p align="justify"><strong>4. Generic Repository</strong></p>
<p align="justify">I am the fan of the repositories used to perform all the CRUD and complex query operations. In the code I have a base repository class and complex repositories deriving from the base class.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span>  <span class="k">class</span> <span class="nc">Repository</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IRepository</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
        <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
    <span class="err">{</span>
        <span class="nc">public</span> <span class="n">T</span> <span class="nf">GetById</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">T</span> <span class="n">klient</span><span class="p">;</span>

            <span class="n">klient</span> <span class="p">=</span> <span class="nf">GetByFilter</span><span class="p">(</span><span class="s">"Id"</span><span class="p">,</span><span class="n">id</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">();</span>

            <span class="k">return</span> <span class="n">klient</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">GetByFilter</span><span class="p">(</span><span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> <span class="kt">object</span> <span class="k">value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">returnedList</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="n">SessionFactory</span><span class="p">.</span><span class="nf">OpenSession</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">returnedList</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">CreateCriteria</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">)).</span><span class="nf">Add</span><span class="p">(</span><span class="n">Expression</span><span class="p">.</span><span class="nf">Eq</span><span class="p">(</span><span class="n">parameterName</span><span class="p">,</span> <span class="k">value</span><span class="p">)).</span><span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
                <span class="n">session</span><span class="p">.</span><span class="nf">Flush</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">returnedList</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">protected</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">GetByQuery</span><span class="p">(</span><span class="kt">string</span> <span class="n">query</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">returnedList</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="n">SessionFactory</span><span class="p">.</span><span class="nf">OpenSession</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">returnedList</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">CreateQuery</span><span class="p">(</span><span class="n">query</span><span class="p">).</span><span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
                <span class="n">session</span><span class="p">.</span><span class="nf">Flush</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">returnedList</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="p">.....</span>

    <span class="p">}</span></code></pre>
</figure>

<p align="justify">Simple Repository used for most CRUD operations.</p>
<p align="justify">For more complex queries , I just create a new class deriving from the base one.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp">    <span class="k">public</span> <span class="k">class</span> <span class="nc">KlientRepository</span> <span class="p">:</span> <span class="n">Repository</span><span class="p">&lt;</span><span class="n">Klient</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">Klient</span> <span class="nf">GetByImieNazwisko</span><span class="p">(</span><span class="kt">string</span> <span class="n">imie</span><span class="p">,</span> <span class="kt">string</span> <span class="n">nazwisko</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">GetByQuery</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"from Klient k where k.Imie = '{0}' and k.Nazwisko = '{1}'"</span><span class="p">,</span><span class="n">imie</span><span class="p">,</span><span class="n">nazwisko</span><span class="p">)).</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Klient</span><span class="p">&gt;</span> <span class="nf">GetByRodzaj</span><span class="p">(</span><span class="kt">string</span> <span class="n">rodzaj</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">GetByQuery</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"from Klient k where k.Rodzaj.Rodzaj = '{0}' "</span><span class="p">,</span> <span class="n">rodzaj</span><span class="p">)).</span><span class="nf">ToList</span><span class="p">();</span>

        <span class="p">}</span>
    <span class="p">}</span></code></pre>
</figure>

<p> </p>

      <span id="post-end"></span>
    </div>

    <div id="mc_embed_signup">
<form action="https://mfranc.us13.list-manage.com/subscribe/post?u=8a5865e28c59044d419ecbe95&amp;id=d545f31150" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL">If you are interested in Cloud Native, Scalability, System Design and more meaty side of Engineering at Scale. Then subscribe to my mailing list.</label>
      <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8a5865e28c59044d419ecbe95_d545f31150" tabindex="-1" value=""></div>
        <div class="clear">
          <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
        </div>
    </div>
</form>
</div>



    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
    <script>
      (function() {
        var d = document,
        s = d.createElement('script');
        s.src = '//thesilenceofthelams.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</aside>



  </div>

</article>

      </div>


      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="http://github.com/michal-franc" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="http://twitter.com/francmichal" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="http://facebook.com/michalfrancblog" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="https://uk.linkedin.com/in/michalfranc1" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>

    <p class="txt-medium-gray">
      <small>&copy;2018 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.slick-modals.js"/></script>

	  <!-- <script id="ulp-remote" src="http://tools.mfranc.com/wp-content/plugins/layered-popups/js/remote.min.js?ver=5.89" data-handler="http://tools.mfranc.com/wp-admin/admin-ajax.php"></script>
	  <script>

		    (function ($) {
			"use strict";
			var objectPositionTop = $('#post-end').offset().top - window.innerHeight;

				ulp_add_event("onexit", {
					popup:		"4AXWiVSrZD71uqiP",
					mode:		"once-period",
					period:		30
				});

				ulp_add_event("onidle", {
					popup:		"85oltSbndJGZQzaW",
					mode:		"once-period",
					period:         30
				});

				ulp_add_event("onscroll", {
					popup:		"INyhHrwTzxjvcqEb",
					mode:		"once-period",
					period:         30,
					offset:		objectPositionTop / 2
				});

		    }(jQuery));

    </script> -->

		<script id="dsq-count-scr" src="//thesilenceofthelams.disqus.com/count.js" async></script>

		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.7&appId=125980610784627";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
    </main>
  </body>
</html>
