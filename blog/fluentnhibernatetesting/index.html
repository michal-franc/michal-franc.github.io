<!DOCTYPE html>
<html>
    <head>

    
    <meta name="robots" content="all">
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Michal Franc">
    <meta name="keywords" content="michal franc,leader,programmer,coach,speaker">
	<title>FluentNHibernate–Testing | Michal Franc</title>
	<meta name="description" content="FluentNHibernateFluentNhibernate framework provides easy way to define mappings in NHibernate. You don’t need to create complex xml files , instead you can u...">

    <link href="https://fonts.googleapis.com/css?family=Inconsolata:700|Raleway" rel="stylesheet">
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <link rel="author" href="https://plus.google.com/104238159697387202725?rel=author">

	<link rel="canonical" href="http://www.mfranc.com/blog/fluentnhibernatetesting/">

    <link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" type="text/css" href="/css/sm.css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Michal Franc | Feed" href="http://feeds.feedburner.com/PassionateProgram">

    <meta property="og:locale" content="en_US">
    <meta property="og:title" content="FluentNHibernate–Testing | Michal Franc">
    <meta property="og:description" content="FluentNHibernateFluentNhibernate framework provides easy way to define mappings in NHibernate. You don’t need to create complex xml files , instead you can u...">
	<meta property="og:url" content="http://www.mfranc.com/blog/fluentnhibernatetesting/">
    <meta property="og:site_name" content="Michal Franc Blog">
    <meta property="og:type" content="website">
	<meta property="og:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

	<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="FluentNHibernate–Testing | Michal Franc">
    <meta name="twitter:site" content="@francmichal">
    <meta name="twitter:creator" content="@francmichal">
    <meta name="twitter:description" content="FluentNHibernateFluentNhibernate framework provides easy way to define mappings in NHibernate. You don’t need to create complex xml files , instead you can u...">
	<meta name="twitter:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15894596-3', 'auto');
  ga('send', 'pageview');
</script>

    <script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100563098); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100563098ns.gif" /></p></noscript>

    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1817837425153843'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1817837425153843&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


  </head>


  <body>
    <main>
      <header class="site-header">
  <div class="container">
	  <h1><a href="/">Michal<span>Franc</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/blog" title="Posts">Posts</a></li>
        
          <li><a href="/notes" title="Notes">Notes</a></li>
        
          <li><a href="/articles" title="Articles">Articles</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">FluentNHibernate–Testing</h1>
      <p class="post-meta">Apr 23, 2011 • Michal Franc - 
		<small>
			<i class="icon icon-comments"></i><span class="disqus-comment-count" data-disqus-url="http://mfranc.com/blog/fluentnhibernatetesting/"></span>
		</small>
		<small>
			
		</small>
	  </p>
    </header>

	<center>
		
	</center>

    <div class="post-content">
      
      <h1 align="justify"></h1>
<h3 align="justify">FluentNHibernate</h3>
<p align="justify"></p>
<p align="justify">FluentNhibernate framework provides easy way to define mappings in NHibernate. You don’t need to create complex xml files , instead you can use C# syntax and write the code in the “.cs” file. FluentNH generates cfg from it.</p>
<p align="justify">Just to show you how this is simple check this class mapping,</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp">        <span class="k">public</span> <span class="nf">GroupModelMap</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Id</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ID</span><span class="p">);</span>
            <span class="nf">Map</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GroupName</span><span class="p">).</span><span class="n">Not</span><span class="p">.</span><span class="nf">Nullable</span><span class="p">();</span>

            <span class="c1">//One
</span>            <span class="nf">References</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GroupType</span><span class="p">).</span><span class="n">Not</span><span class="p">.</span><span class="nf">LazyLoad</span><span class="p">();</span>

            <span class="c1">//Many
</span>            <span class="nf">HasMany</span><span class="p">(</span><span class="n">x</span><span class="p">=&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">Users</span><span class="p">);</span>           
        <span class="p">}</span></code></pre>
</figure>

<p align="justify">Mapped class looks like this :</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp">    <span class="k">public</span> <span class="k">class</span> <span class="nc">GroupModel</span> 
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">ID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">GroupName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="n">GroupTypeModel</span> <span class="n">GroupType</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="k">virtual</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">ProfileModel</span><span class="p">&gt;</span> <span class="n">Users</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">}</span></code></pre>
</figure>

<p align="justify">Every property needs to be marked as virtual and every mapped class needs ID property. It’s just simple as that. There are many options you can use. But I wont go into details in this post. If you want to try it just check the <a href="http://fluentnhibernate.org/">site</a>.</p>
<p align="justify">In this post ,I want to show you other aspects of FluentNHibernate , that can make your life easier. FluentNH is not only about mappings anymore it provides lots of more functionalities.</p>
<p align="justify"></p>

<h3 align="justify">In Memory Testing</h3>
<p align="justify"></p>
<p align="justify">When testing NHibernate layer , it is a good way to use database stored in memory. Unit tests should be isolated , so by running tests on Database Engine you break this rule.</p>
<p align="justify">For InMemory DB  , I  prefer the SqlLite database engine. Its quite good and FluentNH has a good “out of box” support for it. Creating InMemory DB can be a painful experience. You can encounter various problems and one of them is session management. With InMemory DB when session is closed data is deleted from memory and you don’t have access to data. In one of the projects , I have implemented my own mechanism based on the <a href="http://www.maciejaniserowicz.com/">Maciej Aniserowicz samples</a>. It worked fine, but also required a lot of testing and improving.</p>
<p align="justify">Fortunately for us Fluent NH provides mechanism for creating the session object leaving you problem of implementing the tests. We just need to provide the SqlLite configuration.</p>
<p align="justify">Something like :</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="n">_configuration</span> <span class="p">=</span> <span class="n">Fluently</span><span class="p">.</span><span class="nf">Configure</span><span class="p">()</span>
                  <span class="p">.</span><span class="nf">Database</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">SQLiteConfiguration</span><span class="p">.</span><span class="n">Standard</span><span class="p">.</span><span class="nf">InMemory</span><span class="p">().</span><span class="nf">ShowSql</span><span class="p">())</span>
                  <span class="p">.</span><span class="nf">Mappings</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">FluentMappings</span><span class="p">.</span><span class="nf">AddFromAssembly</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ProfileModel</span><span class="p">).</span><span class="n">Assembly</span><span class="p">))</span>
                  <span class="p">.</span><span class="nf">BuildConfiguration</span><span class="p">();</span></code></pre>
</figure>

<p> </p>
<p align="justify">Then you can create session and use it for tests.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">sessionSource</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SingleConnectionSessionSourceForSQLiteInMemoryTesting</span><span class="p">(</span><span class="n">configuration</span><span class="p">);</span>

<span class="n">ISession</span> <span class="n">session</span> <span class="p">=</span> <span class="n">sessionSource</span><span class="p">.</span><span class="nf">CreateSession</span><span class="p">()</span></code></pre>
</figure>

<h3 align="justify">Testing Nhibernate Mappings</h3>
<p align="justify">In unit test world with ORM layers it is good idea to test mappings. Writing your own tests can be a mundane and boring task. FluentNHibernate provides  a way to test it quite simply.</p>
<p align="justify">You can use the PersistenceSpecification class</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">new</span> <span class="n">PersistenceSpecification</span><span class="p">&lt;</span><span class="n">ForumModel</span><span class="p">&gt;(</span><span class="n">session</span><span class="p">,</span> <span class="k">new</span> <span class="nf">IDEqualityComparer</span><span class="p">())</span>
       <span class="p">.</span><span class="nf">CheckProperty</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
       <span class="p">.</span><span class="nf">CheckProperty</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">Author</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
       <span class="p">.</span><span class="n">CheckList</span><span class="p">&lt;</span><span class="n">TopicModel</span><span class="p">&gt;(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">Topics</span><span class="p">,</span>
                   <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">TopicModel</span><span class="p">&gt;()</span> 
                        <span class="p">{</span> 
                            <span class="k">new</span> <span class="nf">TopicModel</span><span class="p">(){</span> <span class="n">Text</span><span class="p">=</span><span class="s">"test"</span><span class="p">}</span>
                        <span class="p">}</span>
                   <span class="p">)</span>
        <span class="p">.</span><span class="nf">VerifyTheMappings</span><span class="p">();</span></code></pre>
</figure>

<p align="justify">This class performs:</p>

<ul>
	<li>
<div align="justify">create ForumModel instance</div></li>
	<li>
<div align="justify">insert this instance to DB</div></li>
	<li>
<div align="justify">retrieve it</div></li>
	<li>
<div align="justify">and verify if returned data is correct</div></li>
</ul>
<p align="justify">Besides the session parameter this class can take Comparer class which defines the your own comparison idea .</p>
<p align="justify">Look at this example. In one of the projects , I am performing comparison based on the unique ID to check if Reference is correct.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp">    <span class="k">public</span> <span class="k">class</span> <span class="nc">IDEqualityComparer</span> <span class="p">:</span> <span class="n">IEqualityComparer</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">object</span> <span class="n">x</span><span class="p">,</span> <span class="kt">object</span> <span class="n">y</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="err">#</span><span class="n">region</span> <span class="n">Comparer</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">y</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="k">is</span> <span class="n">IModel</span> <span class="p">&amp;</span><span class="n">amp</span><span class="p">;&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">y</span> <span class="k">is</span> <span class="n">IModel</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="p">((</span><span class="n">IModel</span><span class="p">)</span><span class="n">x</span><span class="p">).</span><span class="n">ID</span> <span class="p">==</span> <span class="p">((</span><span class="n">IModel</span><span class="p">)</span><span class="n">y</span><span class="p">).</span><span class="n">ID</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">y</span><span class="p">);</span> 
            <span class="err">#</span><span class="n">endregion</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="nf">GetHashCode</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span></code></pre>
</figure>

<p align="justify">IModel is used here to shorten the code. It contains only ID property. Every model class implements it.</p>
<p align="justify">More info</p>
<p align="justify"><a href="http://wiki.fluentnhibernate.org/Persistence_specification_testing">http://wiki.fluentnhibernate.org/Persistence_specification_testing</a></p>

      <span id="post-end"></span>
    </div>

    <div id="mc_embed_signup">
<form action="https://mfranc.us13.list-manage.com/subscribe/post?u=8a5865e28c59044d419ecbe95&amp;id=d545f31150" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL">If you are interested in Cloud Native, Scalability, System Design and more meaty side of Engineering at Scale. Then subscribe to my mailing list.</label>
      <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8a5865e28c59044d419ecbe95_d545f31150" tabindex="-1" value=""></div>
        <div class="clear">
          <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
        </div>
    </div>
</form>
</div>



    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
    <script>
      (function() {
        var d = document,
        s = d.createElement('script');
        s.src = '//thesilenceofthelams.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</aside>



  </div>

</article>

      </div>


      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="http://github.com/michal-franc" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="http://twitter.com/francmichal" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="http://facebook.com/michalfrancblog" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="https://uk.linkedin.com/in/michalfranc1" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>

    <p class="txt-medium-gray">
      <small>&copy;2018 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.slick-modals.js"/></script>

	  <!-- <script id="ulp-remote" src="http://tools.mfranc.com/wp-content/plugins/layered-popups/js/remote.min.js?ver=5.89" data-handler="http://tools.mfranc.com/wp-admin/admin-ajax.php"></script>
	  <script>

		    (function ($) {
			"use strict";
			var objectPositionTop = $('#post-end').offset().top - window.innerHeight;

				ulp_add_event("onexit", {
					popup:		"4AXWiVSrZD71uqiP",
					mode:		"once-period",
					period:		30
				});

				ulp_add_event("onidle", {
					popup:		"85oltSbndJGZQzaW",
					mode:		"once-period",
					period:         30
				});

				ulp_add_event("onscroll", {
					popup:		"INyhHrwTzxjvcqEb",
					mode:		"once-period",
					period:         30,
					offset:		objectPositionTop / 2
				});

		    }(jQuery));

    </script> -->

		<script id="dsq-count-scr" src="//thesilenceofthelams.disqus.com/count.js" async></script>

		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.7&appId=125980610784627";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
    </main>
  </body>
</html>
