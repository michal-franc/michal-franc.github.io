<!DOCTYPE html>
<html>
    <head>

    
    <meta name="robots" content="noindex">
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Michal Franc">
    <meta name="keywords" content="michal franc,leader,programmer,coach,speaker">
	<title>Everything you wanted to know about Sorting in .NET part 4 | Michal Franc</title>
	<meta name="description" content="  Contents">

    <link href="https://fonts.googleapis.com/css?family=Inconsolata:700|Raleway" rel="stylesheet">
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <link rel="author" href="https://plus.google.com/104238159697387202725?rel=author">

	<link rel="canonical" href="http://www.mfranc.com/blog/net-sorting-part4/">

    <link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" type="text/css" href="/css/sm.css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Michal Franc | Feed" href="http://feeds.feedburner.com/PassionateProgram">

    <meta property="og:locale" content="en_US">
    <meta property="og:title" content="Everything you wanted to know about Sorting in .NET part 4 | Michal Franc">
    <meta property="og:description" content="  Contents">
	<meta property="og:url" content="http://www.mfranc.com/blog/net-sorting-part4/">
    <meta property="og:site_name" content="Michal Franc Blog">
    <meta property="og:type" content="website">
	<meta property="og:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

	<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Everything you wanted to know about Sorting in .NET part 4 | Michal Franc">
    <meta name="twitter:site" content="@francmichal">
    <meta name="twitter:creator" content="@francmichal">
    <meta name="twitter:description" content="  Contents">
	<meta name="twitter:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15894596-3', 'auto');
  ga('send', 'pageview');
</script>

    <script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100563098); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100563098ns.gif" /></p></noscript>

    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1817837425153843'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1817837425153843&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


  </head>


  <body>
    <main>
      <header class="site-header">
  <div class="container">
	  <h1><a href="/">Michal<span>Franc</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/blog" title="Posts">Posts</a></li>
        
          <li><a href="/notes" title="Notes">Notes</a></li>
        
          <li><a href="/articles" title="Articles">Articles</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">Everything you wanted to know about Sorting in .NET part 4</h1>
      <p class="post-meta">Apr 1, 2018 • Michal Franc - 
		<small>
			<i class="icon icon-comments"></i><span class="disqus-comment-count" data-disqus-url="http://mfranc.com/blog/net-sorting-part4/"></span>
		</small>
		<small>
			
			<a class="tag-badge" href="/blog/tags/#algorithms">algorithms</a>
			
		</small>
	  </p>
    </header>

	<center>
		
	</center>

    <div class="post-content">
      
        






<div class="seriesNote">
    This article is <strong>Part 7</strong> in a <strong>7-Part</strong> Series.
    <ul>
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
      
        
          
              
              <li>Part 1 - 
              
                  <a href="/blog/net-sorting-intro/">Journey through the internals of .NET Sort</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 2 - 
              
                  <a href="/blog/net-sorting-part1/">Everything you wanted to know about Sorting in .NET - part I</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 3 - 
              
                  <a href="/blog/net-sorting-part3/">Everything you wanted to know about Sorting in .NET part 3</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 4 - 
              
                  <a href="/blog/net-sorting-part2/">Everything you wanted to know about Sorting in .NET part 2</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 5 - 
              
                  <a href="/blog/net-sorting-part6/">Everything you wanted to know about Sorting in .NET part 6</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 6 - 
              
                  <a href="/blog/net-sorting-part5/">Everything you wanted to know about Sorting in .NET part 5</a>
              
              </li>
          
        
      
        
          
              
              <li>Part 7 - 
              
                  This Article
              
              </li>
          
        
      
    
    </ul>
</div>




      
      <div class="toc">
  <h2>Contents</h2>
<ol id="markdown-toc">
  <li><a href="#calling-convention" id="markdown-toc-calling-convention">Calling convention</a></li>
  <li><a href="#how-does-machine-code-works-how-does-code-works-turning-machine" id="markdown-toc-how-does-machine-code-works-how-does-code-works-turning-machine">How does machine code works? how does code works? Turning machine?</a></li>
</ol>

</div>

<p>In this blog post we will answer the question <code class="highlighter-rouge">What is a calling convention?</code></p>

<p>TODO:
- description how machine code looks like and how function work</p>

<h3 id="calling-convention">Calling convention</h3>

<p>A calling convention is like a contract that describes how the functions, on the <code class="highlighter-rouge">assembly</code> code level, communicate with each other using <code class="highlighter-rouge">cpu</code> instructions`.</p>

<p>Contract defines things like:</p>

<ul>
  <li>the way arguments are passed to a function</li>
  <li>how values are returned</li>
  <li>how the function name is decorated</li>
  <li>who: <code class="highlighter-rouge">caller</code> or <code class="highlighter-rouge">calle</code> handles <code class="highlighter-rouge">stack</code> or <code class="highlighter-rouge">registers</code> cleanup</li>
</ul>

<blockquote>
  <p>It specifies how (at a low level) the compiler will pass input parameters to the function and retrieve its results once it’s been executed.<sup id="fnref:calling-convs-so"><a href="#fn:calling-convs-so" class="footnote">1</a></sup></p>
</blockquote>

<p>If we go down to the lowest levels of <code class="highlighter-rouge">code</code>, there is a <code class="highlighter-rouge">machine code</code><sup id="fnref:machine-code"><a href="#fn:machine-code" class="footnote">2</a></sup>.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="m">8</span><span class="n">B542408</span> <span class="m">83F</span><span class="n">A0077</span> <span class="m">06</span><span class="n">B80000</span> <span class="m">0000</span><span class="n">C383</span>
<span class="n">FA027706</span> <span class="n">B8010000</span> <span class="m">00</span><span class="n">C353BB</span> <span class="m">01000000</span>
<span class="n">B9010000</span> <span class="m">008D0419</span> <span class="m">83F</span><span class="n">A0376</span> <span class="m">078</span><span class="n">BD989</span>
<span class="n">C14AEBF1</span> <span class="m">5</span><span class="n">BC3</span></code></pre>
</figure>

<p>This is btw a Fibonnaacci number generation code in <code class="highlighter-rouge">machine code</code>. I wouldn’t be able to write it that way, but what is important is that on this <code class="highlighter-rouge">lowest level</code> it really doesn’t matter if this code  was <code class="highlighter-rouge">created</code> from <code class="highlighter-rouge">C++</code>, <code class="highlighter-rouge">Java</code>, <code class="highlighter-rouge">Python</code> or <code class="highlighter-rouge">C#</code>.</p>

<p>It would an <code class="highlighter-rouge">impossible</code> task(almost) to write code that way and that is why new abstractions were invented like <code class="highlighter-rouge">assembly</code> language. Example below is the same <code class="highlighter-rouge">fibonacci number</code> generation code but in <code class="highlighter-rouge">assembly</code>.</p>

<figure class="highlight">
  <pre><code class="language-asm" data-lang="asm">fib:
    mov edx, [esp+8]
    cmp edx, 0
    ja @f
    mov eax, 0
    ret
    
    @@:
    cmp edx, 2
    ja @f
    mov eax, 1
    ret
    
    @@:
    push ebx
    mov ebx, 1
    mov ecx, 1
    
    @@:
        lea eax, [ebx+ecx]
        cmp edx, 3
        jbe @f
        mov ebx, ecx
        mov ecx, eax
        dec edx
    jmp @b
    
    @@:
    pop ebx
    ret</code></pre>
</figure>

<p>On this level which is still very low. We operate very close to <code class="highlighter-rouge">CPU</code> using - registers, stacks, various operations like <code class="highlighter-rouge">mov</code>, <code class="highlighter-rouge">jmp</code>. Every machine supports different <code class="highlighter-rouge">registers</code> and <code class="highlighter-rouge">instructions</code><a href="https://en.wikipedia.org/wiki/List_of_instruction_sets">[x]</a>. Some operate on very primitive instructions and some have more complicated ones. Example <a href="https://stackoverflow.com/questions/14794460/how-does-the-arm-architecture-differ-from-x86">[x]</a>.</p>

<figure class="highlight">
  <pre><code class="language-asm" data-lang="asm">x86
-----

repe cmpsb         /* repeat while equal compare string bytewise */

ARM
-----

top:
ldrb r2, [r0, #1]! /* load a byte from address in r0 into r2, increment r0 after */
ldrb r3, [r1, #1]! /* load a byte from address in r1 into r3, increment r1 after */
subs r2, r3, r2    /* subtract r2 from r3 and put result into r2      */
beq  top           /* branch(/jump) if result is zero                 */</code></pre>
</figure>

<p>It is the same code but on different architecture with different instruction sets. It is just like diffeences on the <code class="highlighter-rouge">high</code> level beetwen languages like <code class="highlighter-rouge">C#</code> and <code class="highlighter-rouge">Java</code>. Due to this differences you need to compile the code for specific machine. If you are int linux world, it is pretty standard procedure to download source code of some program, tool and build by your own on your machine for your machine specific architecture and instructions sets. More popular distributions have packages with already precompiled binaries. That is why things like <code class="highlighter-rouge">java virtual machine</code> and <code class="highlighter-rouge">clr</code> were created. They server as a intermidiary beetwen code and machine using <code class="highlighter-rouge">byte code</code> and <code class="highlighter-rouge">JIT</code> compilation, compiling code on the fly to match the machine.</p>

<p>If in the the end all there is ‘assembly’ then it should be easy to communicate beetwen different languages. Devil is in the details. The machine doesn’t really know which language ultimately generated instructions set that is execcuted by it. But the more we go <code class="highlighter-rouge">one level up</code> the more differences are there. There are different compilers, different flags, different languages, different architecture, different contexts and different conventions.</p>

<p>One of the important difference, I want to talk aobut is <code class="highlighter-rouge">calling convention</code>. As mentioned earlier it is like a contract exposed by one function to other to tell it how to communicate with it. If function <code class="highlighter-rouge">A</code> uses different convention than function <code class="highlighter-rouge">B</code> they won’t be able to call each other.</p>

<h2 id="how-does-machine-code-works-how-does-code-works-turning-machine">How does machine code works? how does code works? Turning machine?</h2>

<p>Calling conventions can differ in many ways:</p>

<ul>
  <li>storage of arguments - registers, stack</li>
  <li>how are the arguments added to the stack - left to right or right to left</li>
  <li>where do you put result of the function call (stack, register, memory)</li>
  <li>who is responsible for stack cleanup - caller or calle ( this makes a difference in assembly code size, if caller is cleaning up the stack - the compiler has to generate cleaning logic every time a function is called)</li>
  <li>who is responsible for <code class="highlighter-rouge">cleaning</code> up <code class="highlighter-rouge">registers</code> and bringing them back to previous state (before the function was called)</li>
</ul>

<p>Analysing few examples, based on <code class="highlighter-rouge">x86 calling conventions</code><a href="https://en.wikipedia.org/wiki/X86_calling_conventions">[x]</a>.</p>

<p>If one of the functions expects call using <code class="highlighter-rouge">cdecl</code> convention. It is expecting:</p>

<ul>
  <li>arguments to be on the stack</li>
  <li>caller cleaning up the stack</li>
</ul>

<p>If we then call this function using <code class="highlighter-rouge">fastcall</code> convention both requirements won’t be met:</p>

<ul>
  <li>for fastcall first <code class="highlighter-rouge">three</code> (for Microsoft <code class="highlighter-rouge">two</code>) arguments are kept in the reggisters, and calle expectes this values on the stack when it is empty</li>
  <li>stack won’t be cleaned up as fastcall assumes that <code class="highlighter-rouge">callee</code> is responsible for that.</li>
</ul>

<p>cdecl example <a href="https://godbolt.org/g/qTgVGm">[x]</a></p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c"><span class="n">__attribute__</span><span class="p">((</span><span class="n">cdecl</span><span class="p">))</span> <span class="kt">int</span> <span class="n">cdecl</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">caller</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">cdecl</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</figure>

<p>This is a simple function that all it does is <code class="highlighter-rouge">multiply</code> numbers. We have a <code class="highlighter-rouge">cdecl</code> which is marked with <code class="highlighter-rouge">cdecl</code> attribute to force this calling convention (this is actually default and this attribute is not needed).</p>

<p>I am compiling this code with two important flags:</p>

<ul>
  <li>-m32 - forces 32 bit executable - without this flag calling coventions are ignored (couldn’t find why)</li>
  <li>-O0 - I don’t want to optimize this code as with such a simple example <code class="highlighter-rouge">-O1</code> in the caller puts a static value <code class="highlighter-rouge">(2 * 3 = 6)</code></li>
  <li><code class="highlighter-rouge">-fomit-frame-pointer</code> - one optimization that removes <code class="highlighter-rouge">frame pointers</code> to make the <code class="highlighter-rouge">asm</code> code a bit simpler. (At the end of this post there is a example without this optimization explained if you are curious what is the diffference).</li>
</ul>

<blockquote>
  <p>-fomit-frame-pointer <br />
Don’t keep the frame pointer in a register for functions that don’t need one. This avoids the instructions to save, set up and restore frame pointers; it also makes an extra register available in many functions. It also makes debugging impossible on some machines. <a href="https://stackoverflow.com/questions/14666665/trying-to-understand-gcc-option-fomit-frame-pointer">[x]</a></p>
</blockquote>

<p>It removes instructions</p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c">  <span class="o">-</span> <span class="n">push</span> <span class="n">ebp</span>      <span class="o">&lt;-</span> <span class="n">preserve</span> <span class="n">the</span> <span class="n">caller</span> <span class="n">function</span> <span class="n">entry</span> <span class="n">point</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="o">-</span> <span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>  <span class="o">&lt;-</span> <span class="n">point</span> <span class="n">ebp</span> <span class="n">to</span> <span class="n">this</span> <span class="n">function</span> <span class="n">stack</span> <span class="n">frame</span> <span class="n">pointer</span> <span class="p">(</span><span class="n">create</span> <span class="n">stack</span> <span class="n">frame</span><span class="p">)</span>
<span class="p">...</span>
  <span class="o">-</span> <span class="n">pop</span> <span class="n">ebp</span>       <span class="o">&lt;-</span> <span class="n">restore</span> <span class="n">entry</span> <span class="n">point</span> <span class="n">from</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">of</span> <span class="n">the</span> <span class="n">calling</span> <span class="n">function</span> <span class="n">to</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">go</span> <span class="n">back</span></code></pre>
</figure>

<p>So how does the <code class="highlighter-rouge">asm</code> code looks like with all this flags?</p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c"><span class="nl">cdecl:</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>  <span class="n">move</span> <span class="n">value</span> <span class="sc">'a'</span> <span class="n">from</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">to</span> <span class="n">the</span> <span class="n">accumulator</span> <span class="n">eax</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="n">multiply</span> <span class="n">eax</span> <span class="n">by</span> <span class="sc">'b'</span> <span class="n">from</span> <span class="n">the</span> <span class="n">stack</span>
                              <span class="o">-&gt;</span> <span class="n">in</span> <span class="n">cdecl</span> <span class="n">called</span> <span class="n">function</span> <span class="n">expects</span> <span class="n">arguments</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">ret</span>
<span class="n">caller</span><span class="o">:</span>
  <span class="n">push</span> <span class="mi">3</span>                      <span class="n">push</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">to</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">push</span> <span class="mi">2</span>                      <span class="n">push</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span> <span class="n">to</span> <span class="n">the</span> <span class="n">stack</span> 
                              <span class="o">-&gt;</span> <span class="n">in</span> <span class="n">cdecl</span> <span class="n">arguments</span> <span class="n">are</span> <span class="n">pushed</span> <span class="n">to</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">call</span> <span class="n">cdecl</span>
  <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>                  <span class="err">'</span><span class="n">clean</span> <span class="n">up</span><span class="err">'</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">by</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">pointer</span>
                              <span class="o">-&gt;</span> <span class="n">in</span> <span class="n">cdecl</span> <span class="n">caller</span> <span class="n">cleans</span> <span class="n">up</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">ret</span></code></pre>
</figure>

<p>We can see all the characteristics of <code class="highlighter-rouge">cdecl</code> call in this <code class="highlighter-rouge">code</code>. I am going to compile now fastcall function using similar flags.</p>

<p>Example of fastcall <a href="https://godbolt.org/g/VFQQmL">[x]</a></p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c"><span class="n">__attribute__</span><span class="p">((</span><span class="n">fastcall</span><span class="p">))</span> <span class="kt">int</span> <span class="n">fastcall</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">caller</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fastcall</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</figure>

<p>I added <code class="highlighter-rouge">third</code> parameter to show that only first <code class="highlighter-rouge">two</code> arguments are passed through the registers.  There is one thing, I am going to change in the code to make it more readable - <code class="highlighter-rouge">fastcall</code> looks like this.</p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c"><span class="nl">fastcall:</span>
  <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>                   <span class="o">-&gt;</span> <span class="n">reserve</span> <span class="n">place</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="n">ecx</span>   <span class="o">-&gt;</span> <span class="n">move</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">to</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span> <span class="n">edx</span>     <span class="o">-&gt;</span> <span class="n">move</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span> <span class="n">to</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>   <span class="o">-&gt;</span> <span class="n">move</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">from</span> <span class="n">stack</span> <span class="n">to</span> <span class="n">eax</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">]</span>    <span class="o">-&gt;</span> <span class="n">multiply</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">on</span> <span class="n">eax</span> <span class="n">by</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">multiply</span> <span class="n">by</span> <span class="err">`</span><span class="n">c</span><span class="err">`</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>                   <span class="o">-&gt;</span> <span class="n">clean</span> <span class="n">up</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">ret</span> <span class="mi">4</span>                        <span class="o">-&gt;</span> <span class="k">return</span> <span class="n">to</span> <span class="n">the</span> <span class="n">caller</span> <span class="n">and</span> <span class="n">move</span> <span class="n">stack</span> <span class="n">pointer</span> <span class="n">cleaning</span> <span class="n">up</span> <span class="err">`</span><span class="n">c</span><span class="err">`</span></code></pre>
</figure>

<p>But it can be simplified to this.</p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c"><span class="nl">fastcall:</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">]</span>
  <span class="n">ret</span> <span class="mi">4</span></code></pre>
</figure>

<p>There is no need to reserver place on <code class="highlighter-rouge">stack</code>, move values from registers to the <code class="highlighter-rouge">stack</code> and then get values from the <code class="highlighter-rouge">stack</code>. Compiler potentialy does it due to <code class="highlighter-rouge">consistency</code>.</p>

<blockquote>
  <p>Arguments are first saved in stack then fetched from stack, rather than be used directly. This is because the compiler wants a consistent way to use all arguments via stack access, not only one compiler does like that.<a href="https://en.wikibooks.org/wiki/X86_Disassembly/Calling_Convention_Examples">[x]</a></p>
</blockquote>

<p>In the end we will analyse this code.</p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c"><span class="nl">fastcall:</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span>              <span class="n">move</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">to</span> <span class="n">eax</span> 
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>             <span class="n">multiply</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">in</span> <span class="n">the</span> <span class="n">eax</span> <span class="n">by</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span> <span class="n">in</span> <span class="n">edx</span>
                            <span class="o">-&gt;</span> <span class="n">in</span> <span class="n">fastcall</span> <span class="n">called</span> <span class="n">function</span> <span class="n">expects</span> <span class="n">arguments</span> <span class="n">in</span> <span class="n">the</span> <span class="n">registers</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">]</span> <span class="n">multiply</span> <span class="n">by</span> <span class="err">`</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="err">`</span> <span class="n">by</span> <span class="err">`</span><span class="n">c</span><span class="err">`</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span><span class="p">,</span> <span class="n">esp</span> <span class="n">is</span> <span class="n">pointing</span> <span class="n">at</span> <span class="n">the</span> <span class="n">top</span> <span class="n">of</span> <span class="n">stack</span>
                            <span class="o">-&gt;</span> <span class="n">in</span> <span class="n">fastcall</span> <span class="n">third</span> <span class="n">parameters</span> <span class="n">is</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">ret</span> <span class="mi">4</span>                     <span class="k">return</span> <span class="n">to</span> <span class="n">the</span> <span class="n">caller</span> <span class="n">and</span> <span class="n">cleanup</span> <span class="n">stack</span> <span class="n">from</span> <span class="err">`</span><span class="n">c</span><span class="err">`</span>
                            <span class="o">-&gt;</span> <span class="n">in</span> <span class="n">fastcall</span> <span class="n">called</span> <span class="n">function</span> <span class="n">is</span> <span class="n">cleaning</span> <span class="n">up</span> <span class="n">the</span> <span class="n">stack</span>
<span class="n">fastcall</span><span class="o">:</span>
  <span class="n">ret</span>
<span class="n">caller</span><span class="o">:</span>
  <span class="n">push</span> <span class="mi">4</span>          <span class="n">move</span> <span class="err">`</span><span class="n">c</span><span class="err">`</span> <span class="n">to</span> <span class="n">the</span> <span class="n">stack</span>
                  <span class="o">-&gt;</span> <span class="n">in</span> <span class="n">fastcall</span> <span class="n">third</span> <span class="n">argument</span> <span class="n">is</span> <span class="n">passed</span> <span class="n">using</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">3</span>      <span class="n">move</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">to</span> <span class="n">edx</span>
  <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">2</span>      <span class="n">move</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span> <span class="n">to</span> <span class="n">ecx</span>
                  <span class="o">-&gt;</span> <span class="n">in</span> <span class="n">fastcall</span> <span class="n">first</span> <span class="mi">2</span> <span class="n">arguments</span> <span class="n">are</span> <span class="n">passed</span> <span class="n">by</span> <span class="n">registers</span>
  <span class="n">call</span> <span class="n">fastcall</span>   
  <span class="n">ret</span></code></pre>
</figure>

<p>We just discussed differences beetwen <code class="highlighter-rouge">fastcall</code> and <code class="highlighter-rouge">cdecl</code> but what if <code class="highlighter-rouge">caller</code> function used different convention than <code class="highlighter-rouge">calle</code> funciton ? Assuming for a while this scenario - the code will look like this.</p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c"><span class="nl">fastcall:</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span>    <span class="o">-&gt;</span> <span class="err">`</span><span class="n">fastcall</span><span class="err">`</span> <span class="n">expects</span> <span class="n">arguments</span> <span class="n">on</span> <span class="n">the</span> <span class="n">registers</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>   
  <span class="n">ret</span>
<span class="n">caller</span><span class="o">:</span>
  <span class="n">push</span> <span class="mi">3</span>          <span class="o">-&gt;</span> <span class="n">but</span> <span class="n">caller</span> <span class="n">pushed</span> <span class="n">arguments</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">push</span> <span class="mi">2</span>         
  <span class="n">call</span> <span class="n">fastcall</span>
  <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span> 
  <span class="n">ret</span></code></pre>
</figure>

<p>In this example <code class="highlighter-rouge">fastcall</code> function will use <code class="highlighter-rouge">somekind</code> of data on the registers. It wouldn’t get the data it was expecting <code class="highlighter-rouge">3</code> and <code class="highlighter-rouge">2</code> but something. This would generate an unexpected and hard to debug behaviour. That is why <code class="highlighter-rouge">calling conventions</code> are important. There is a long history behind them <sup id="fnref:cc-history1"><a href="#fn:cc-history1" class="footnote">3</a></sup><sup id="fnref:cc-history2"><a href="#fn:cc-history2" class="footnote">4</a></sup><sup id="fnref:cc-history3"><a href="#fn:cc-history3" class="footnote">5</a></sup><sup id="fnref:cc-history4"><a href="#fn:cc-history4" class="footnote">6</a></sup></p>

<p>Next post in the series will expand on it and describe the link beetwen <code class="highlighter-rouge">JIT</code>, <code class="highlighter-rouge">CLR</code>, <code class="highlighter-rouge">calling conventions</code> and <code class="highlighter-rouge">FCall</code>.</p>

<p>https://msdn.microsoft.com/en-us/library/6xa169sk.aspx
https://msdn.microsoft.com/en-us/library/984x0h58.aspx</p>

<p>https://gcc.gnu.org/onlinedocs/gcc/x86-Function-Attributes.html</p>

<figure class="highlight">
  <pre><code class="language-c" data-lang="c"><span class="n">This</span> <span class="n">code</span> <span class="n">is</span> <span class="n">using</span> <span class="n">no</span> <span class="n">opitmizations</span> <span class="o">-</span><span class="n">O0</span> 
<span class="n">Other</span> <span class="n">flags</span> <span class="n">used</span><span class="o">:</span>
<span class="o">-</span><span class="n">m32</span> <span class="o">-</span> <span class="n">to</span> <span class="n">force</span> <span class="mi">32</span> <span class="n">bits</span> <span class="n">as</span> <span class="n">on</span> <span class="mi">64</span> <span class="n">calling</span> <span class="n">conventions</span> <span class="n">are</span> <span class="n">ignored</span>

<span class="n">cdecl</span><span class="o">:</span>
  <span class="n">push</span> <span class="n">ebp</span>                    <span class="o">&lt;-</span> <span class="n">preserve</span> <span class="n">the</span> <span class="n">caller</span> <span class="n">function</span> <span class="n">entry</span> <span class="n">point</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>                <span class="o">&lt;-</span> <span class="n">point</span> <span class="n">ebp</span> <span class="n">to</span> <span class="n">this</span> <span class="n">function</span> <span class="n">stack</span> <span class="n">frame</span> <span class="n">pointer</span> <span class="p">(</span><span class="n">create</span> <span class="n">stack</span> <span class="n">frame</span><span class="p">)</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>  <span class="o">&lt;-</span> <span class="n">move</span> <span class="n">value</span> <span class="sc">'a'</span> <span class="n">from</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">frame</span> <span class="n">to</span> <span class="n">the</span> <span class="n">accumulator</span> <span class="n">eax</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span><span class="o">&lt;-</span> <span class="n">multiply</span> <span class="n">eax</span> <span class="n">by</span> <span class="sc">'b'</span> <span class="n">from</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">frame</span>
  <span class="n">pop</span> <span class="n">ebp</span>                     <span class="o">&lt;-</span> <span class="n">restore</span> <span class="n">entry</span> <span class="n">point</span> <span class="n">from</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">of</span> <span class="n">the</span> <span class="n">calling</span> <span class="n">function</span> <span class="n">to</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">go</span> <span class="n">back</span>
  <span class="n">ret</span>                         <span class="o">&lt;-</span> <span class="k">return</span> <span class="n">to</span> <span class="n">the</span> <span class="n">entry</span> <span class="n">point</span> <span class="n">of</span> <span class="n">the</span> <span class="n">calling</span> <span class="n">function</span>
<span class="n">fastcall</span><span class="o">:</span>                     
  <span class="n">push</span> <span class="n">ebp</span>                    <span class="o">&lt;-</span> <span class="n">preserve</span> <span class="n">caller</span> <span class="n">function</span> <span class="n">entry</span> <span class="n">point</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>                <span class="o">&lt;-</span> <span class="n">point</span> <span class="n">ebp</span> <span class="n">to</span> <span class="n">this</span> <span class="n">function</span> <span class="n">stack</span> <span class="n">pointer</span> <span class="p">(</span><span class="n">create</span> <span class="n">stack</span> <span class="n">frame</span><span class="p">)</span>
  <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>                  <span class="o">&lt;-</span> <span class="n">allocate</span> <span class="n">space</span> <span class="k">for</span> <span class="mi">2</span> <span class="n">items</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">frame</span> <span class="p">(</span><span class="n">using</span> <span class="n">substraction</span><span class="p">)</span> 
  <span class="n">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">ecx</span>  <span class="o">&lt;-</span> <span class="n">put</span> <span class="n">the</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">from</span> <span class="n">ecx</span> <span class="k">register</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="n">edx</span>  <span class="o">&lt;-</span> <span class="n">put</span> <span class="n">the</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span> <span class="n">from</span> <span class="n">edx</span> <span class="k">register</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>  <span class="o">&lt;-</span> <span class="n">move</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">to</span> <span class="n">accumulator</span> <span class="n">eax</span>
  <span class="n">imul</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">multiply</span> <span class="n">by</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span>
  <span class="n">mov</span> <span class="n">esp</span><span class="p">,</span> <span class="n">ebp</span>                <span class="o">&lt;-</span> <span class="err">`</span><span class="n">destroy</span><span class="err">`</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">pop</span> <span class="n">ebp</span>                     <span class="o">&lt;-</span> <span class="n">restore</span> <span class="n">entry</span> <span class="n">point</span> <span class="n">of</span> <span class="n">the</span> <span class="n">caller</span>
  <span class="n">ret</span>                         <span class="o">&lt;-</span> <span class="k">return</span> <span class="n">to</span> <span class="n">the</span> <span class="n">entry</span> <span class="n">point</span> <span class="n">of</span> <span class="n">the</span> <span class="n">calling</span> <span class="n">function</span>
<span class="n">caller</span><span class="o">:</span>
  <span class="n">push</span> <span class="n">ebp</span>                    
  <span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
  <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">24</span>                 <span class="o">&lt;-</span> <span class="n">make</span> <span class="n">space</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
  <span class="n">push</span> <span class="mi">3</span>                      <span class="o">&lt;-</span> <span class="n">push</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">to</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">push</span> <span class="mi">2</span>                      <span class="o">&lt;-</span> <span class="n">push</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span> <span class="n">to</span> <span class="n">the</span> <span class="n">stack</span> 
  <span class="n">call</span> <span class="n">cdecl</span>
  <span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">16</span>                 <span class="o">&lt;-</span> <span class="err">'</span><span class="n">clean</span> <span class="n">up</span><span class="err">'</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">12</span><span class="p">],</span> <span class="n">eax</span> <span class="o">&lt;-</span> <span class="n">after</span> <span class="n">cdecl</span> <span class="n">call</span> <span class="n">eax</span> <span class="n">contains</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="n">result</span> <span class="n">of</span> <span class="n">cdecl</span> <span class="n">function</span><span class="p">,</span> <span class="n">put</span> <span class="n">it</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">3</span>                  <span class="o">&lt;-</span> <span class="n">move</span> <span class="err">`</span><span class="n">a</span><span class="err">`</span> <span class="n">to</span> <span class="n">edx</span> <span class="k">register</span>
  <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">2</span>                  <span class="o">&lt;-</span> <span class="n">move</span> <span class="err">`</span><span class="n">b</span><span class="err">`</span> <span class="n">to</span> <span class="n">ecx</span> <span class="k">register</span>
  <span class="n">call</span> <span class="n">fastcall</span>
  <span class="n">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">16</span><span class="p">],</span> <span class="n">eax</span> <span class="o">&lt;-</span> <span class="n">eax</span> <span class="n">contains</span> <span class="n">result</span> <span class="n">of</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="n">from</span> <span class="n">fastcall</span> <span class="n">function</span> <span class="n">put</span> <span class="n">it</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
  <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">put</span> <span class="n">result</span> <span class="n">of</span> <span class="n">cdecl</span> <span class="n">on</span> <span class="n">the</span> <span class="k">register</span>
  <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">put</span> <span class="n">result</span> <span class="n">of</span> <span class="n">fastcall</span> <span class="n">on</span> <span class="n">the</span> <span class="k">register</span>
  <span class="n">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>                <span class="o">&lt;-</span> <span class="n">add</span> <span class="n">and</span> <span class="n">leave</span> <span class="n">the</span> <span class="n">value</span> <span class="n">on</span> <span class="n">eax</span> <span class="k">for</span> <span class="n">the</span> <span class="n">caller</span> <span class="n">to</span> <span class="n">use</span>
  <span class="n">mov</span> <span class="n">esp</span><span class="p">,</span> <span class="n">ebp</span>                <span class="o">&lt;-</span> <span class="err">`</span><span class="n">destroy</span><span class="err">`</span> <span class="n">stack</span>
  <span class="n">pop</span> <span class="n">ebp</span>
  <span class="n">ret</span>

<span class="n">With</span> <span class="n">level</span> <span class="mi">1</span> <span class="n">optimziation</span> <span class="o">-</span><span class="mo">01</span> <span class="n">this</span> <span class="n">looks</span> <span class="n">even</span> <span class="n">more</span> <span class="n">clear</span></code></pre>
</figure>

<p>Diffs: (in the simplified code example)</p>

<ul>
  <li>fastcall uses edx and ecx registers</li>
  <li>cdecl uses stack</li>
  <li>fastcall using mov esp, ebp cleans up the stack</li>
  <li>cdeccl doesnt do this the caller is ussing add esp, 16 to clea up the stack</li>
</ul>

<p>I replaced leave instructions with 
mov esp, ebp
pop ebp</p>

<p>sub esp
add esp
instructions are nicely explained here stack operations<a href="https://en.wikibooks.org/wiki/X86_Disassembly/The_Stack">[x]</a></p>

<div class="footnotes">
  <ol>
    <li id="fn:calling-convs-so">
      <p><a href="https://stackoverflow.com/questions/10671281/what-is-the-fastcall-keyword-used-for-in-visual-c">StackOverflow ‘What is the fastcall keyword…’</a> <a href="#fnref:calling-convs-so" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:machine-code">
      <p><a href="https://en.wikipedia.org/wiki/Low-level_programming_language">https://en.wikipedia.org/wiki/Low-level_programming_language</a> <a href="#fnref:machine-code" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:cc-history1">
      <p><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040102-00/?p=41213">The history of calling conventions, part1</a> <a href="#fnref:cc-history1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:cc-history2">
      <p><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040107-00/?p=41183">The history of calling conventions, part2</a> <a href="#fnref:cc-history2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:cc-history3">
      <p><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040108-00/?p=41163">The history of calling conventions, part3</a> <a href="#fnref:cc-history3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:cc-history4">
      <p><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040113-00/?p=41073">The history of calling conventions, part4</a> <a href="#fnref:cc-history4" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>


      <span id="post-end"></span>
    </div>

    <div id="mc_embed_signup">
<form action="https://mfranc.us13.list-manage.com/subscribe/post?u=8a5865e28c59044d419ecbe95&amp;id=d545f31150" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL">If you are interested in Cloud Native, Scalability, System Design and more meaty side of Engineering at Scale. Then subscribe to my mailing list.</label>
      <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8a5865e28c59044d419ecbe95_d545f31150" tabindex="-1" value=""></div>
        <div class="clear">
          <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
        </div>
    </div>
</form>
</div>



    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
    <script>
      (function() {
        var d = document,
        s = d.createElement('script');
        s.src = '//thesilenceofthelams.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</aside>



  </div>

</article>

      </div>


      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="http://github.com/michal-franc" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="http://twitter.com/francmichal" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="http://facebook.com/michalfrancblog" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="https://uk.linkedin.com/in/michalfranc1" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>

    <p class="txt-medium-gray">
      <small>&copy;2018 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.slick-modals.js"/></script>

	  <!-- <script id="ulp-remote" src="http://tools.mfranc.com/wp-content/plugins/layered-popups/js/remote.min.js?ver=5.89" data-handler="http://tools.mfranc.com/wp-admin/admin-ajax.php"></script>
	  <script>

		    (function ($) {
			"use strict";
			var objectPositionTop = $('#post-end').offset().top - window.innerHeight;

				ulp_add_event("onexit", {
					popup:		"4AXWiVSrZD71uqiP",
					mode:		"once-period",
					period:		30
				});

				ulp_add_event("onidle", {
					popup:		"85oltSbndJGZQzaW",
					mode:		"once-period",
					period:         30
				});

				ulp_add_event("onscroll", {
					popup:		"INyhHrwTzxjvcqEb",
					mode:		"once-period",
					period:         30,
					offset:		objectPositionTop / 2
				});

		    }(jQuery));

    </script> -->

		<script id="dsq-count-scr" src="//thesilenceofthelams.disqus.com/count.js" async></script>

		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.7&appId=125980610784627";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
    </main>
  </body>
</html>
