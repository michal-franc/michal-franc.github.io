---
layout: draft
title: Everything you wanted to know about Sorting in .NET part 5
date: 2018-04-01 07:00
author: Michal Franc
comments: true
categories: [Tech]
tags: [algorithms]
series: net-sorting
permalink: /blog/net-sorting-part5/
---

JIT calling conventions
http://www.newardassociates.com/files/SSCLI2.pdf -> 130

Ttemporary method entry point  and pre stubs
http://www.newardassociates.com/files/SSCLI2.pdf -> 120

Frames + StackWalking
http://www.newardassociates.com/files/SSCLI2.pdf -> 194

### FCall and __fastcall

As mentioned in `coreclr` docs. `FCall` uses `__fastcall` which is supposed to be faster as it uses `registers` to pass some of the arguments. Registers passing is faster and there is no need for operations on the stack to pass the arguments. Whats more there is amention of `direct call` without stub and frames.

>  An `FCall` target uses `__fastcall` or some other calling convention to match the IL calling convention exactly. Thus, a call to FCall is a direct call to the target without no intervening stub or frames.

How does it look like in code? Can i debug? it or dissasemble it?

We need to explains `stubs` and `frames` - a bit.

`Stub` is something generated byc `CLR`. It is used to handle marshalling and call/invocation of a target method. When we have a `managed` function, it cannot call the `unmanaged` function just like that. There has to be a intermediary that helps these too to connect. This thing is called `marshalling stub`(I think stub has a lot of meaning but in this example it is something in the middle).

`marshalling stub` handles things like:

* initialization
* marshaling of input parameters
* invocation of the method
* marshaling back of the return value
* cleanup 

`frames` - stack is filled with `frames`. When a method is called a new frame is erected and it contains informations about `params`, `variables` and many other thingss. 

Beacuse bby default there is no need for `frames` or `stubs` and `FCall` entry pint is directly calledd this method is faster. You have to create frames for scenarios like `throwing exception` or calling `garbage collection` in `FCall`.

In `QCall` and `P/Invoke` frames and marshalling stubs are genereted automatically. This is a hit to the performance but it provides features that can help write safer code. Also if you use `FCall` and need to throw `Exception` or call `Garbage Collection` you need to ceate a `frame` - `frame is required` to pass information to the runtime that you want to do this operation??

Different language also represent types differently in the memory that I why you need marshaling stub to translate between two worlds.

What is the IL calling convention. how does it's look like in the visual studio dism. That is why fcimpl and fcall is great, it matches convention to the one's use by il and that I generate by jitter to remove intermediary step like marshaling stub. 
(frame has to provide something with GC and exceptions asm code in cpp exception looks different than the exception in il, runtime wouldnt be able to understand exception thrown in cpp without this translational step) frame I encoding state in one context it is then use im different context to rebuild it. Stack frame is like a meta data conteact. 

TODO:
- definitely identify parts that require verification from .net internals expert - konrad kokosa
- propose to konrad book advertisement if he has some landing page
- normally in ASM there is a call instruction (what is it?)

Machine Learning based search
https://arxiv.org/pdf/1805.04272.pdf

Profile somehow - Sort with comparere and TrySZSort? show calls?

