<!DOCTYPE html>
<html>
    <head>

    
    <meta name="robots" content="all">
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="author" content="Michal Franc">
    <meta name="keywords" content="michal franc,leader,programmer,coach,speaker">
	<title>LockBits vs Get Pixel Set Pixel - Performance | Michal Franc</title>
	<meta name="description" content="When using GDI+ method you can optimize the process of bitmap manipulation  seven  times.I am implementing an image scaling algorithm at my University Seam C...">

    <link href="https://fonts.googleapis.com/css?family=Inconsolata:700|Raleway" rel="stylesheet">
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <link rel="author" href="https://plus.google.com/104238159697387202725?rel=author">

	<link rel="canonical" href="http://www.mfranc.com/programming/operacje-na-bitmapkach-net-1/">

    <link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" type="text/css" href="/css/sm.css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Michal Franc | Feed" href="http://feeds.feedburner.com/PassionateProgram">

    <meta property="og:locale" content="en_US">
    <meta property="og:title" content="LockBits vs Get Pixel Set Pixel - Performance | Michal Franc">
    <meta property="og:description" content="When using GDI+ method you can optimize the process of bitmap manipulation  seven  times.I am implementing an image scaling algorithm at my University Seam C...">
	<meta property="og:url" content="http://www.mfranc.com/programming/operacje-na-bitmapkach-net-1/">
    <meta property="og:site_name" content="Michal Franc Blog">
    <meta property="og:type" content="website">
	<meta property="og:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

	<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="LockBits vs Get Pixel Set Pixel - Performance | Michal Franc">
    <meta name="twitter:site" content="@francmichal">
    <meta name="twitter:creator" content="@francmichal">
    <meta name="twitter:description" content="When using GDI+ method you can optimize the process of bitmap manipulation  seven  times.I am implementing an image scaling algorithm at my University Seam C...">
	<meta name="twitter:image" content="http://michal-franc.github.io/images/default_share_image.jpg">

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15894596-3', 'auto');
  ga('send', 'pageview');
</script>

    <script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100563098); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100563098ns.gif" /></p></noscript>

    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1817837425153843'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1817837425153843&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


  </head>


  <body>
    <main>
      <header class="site-header">
  <div class="container">
	  <h1><a href="/">Michal<span>Franc</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/blog" title="Posts">Posts</a></li>
        
          <li><a href="/notes" title="Notes">Notes</a></li>
        
          <li><a href="/articles" title="Articles">Articles</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">LockBits vs Get Pixel Set Pixel - Performance</h1>
      <p class="post-meta">Nov 22, 2009 • Michal Franc - 
		<small>
			<i class="icon icon-comments"></i><span class="disqus-comment-count" data-disqus-url="http://mfranc.com/programming/operacje-na-bitmapkach-net-1/"></span>
		</small>
		<small>
			
		</small>
	  </p>
    </header>

	<center>
		
	</center>

    <div class="post-content">
      
      <p align="justify">When using <strong>GDI+</strong> method you can <strong>optimize</strong> the process of bitmap manipulation  seven  times.I am implementing an image scaling algorithm at my University <a href="http://lammichalfranc.wordpress.com/2009/11/20/seam-carving-part-1/"><strong>Seam Carving</strong></a> . While working on this project I realized that simply accessing pixels by the <strong>GetPixel</strong> and <strong>SetPixel</strong> methods is too slow.</p>

<h2>GetPixel , SetPixel</h2>
<p align="justify">This is a really easy solution. We have two functions <strong>GetPixel</strong> and <strong>SetPixel</strong> both  have x and y coordinate as argument. <strong>GetPixel</strong> returns a color and <strong>SetPixel</strong> sets a color on the coordinate.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="nf">GetPixel</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">SetPixel</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="kt">int</span> <span class="n">y</span><span class="p">,</span><span class="n">Color</span> <span class="n">color</span><span class="p">)</span></code></pre>
</figure>

<p align="justify">With the use of those functions, we can easily iterate through all the <strong>pixels</strong> in the image by simply modifying the x and y variable.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">y</span> <span class="p">&lt;</span> <span class="n">_bmp</span><span class="p">.</span><span class="n">Height</span><span class="p">;</span> <span class="n">y</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="n">_bmp</span><span class="p">.</span><span class="n">Width</span><span class="p">;</span> <span class="n">x</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">_bmp</span><span class="p">.</span><span class="nf">SetPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">color</span><span class="p">);</span>
        <span class="n">Color</span> <span class="n">c</span> <span class="p">=</span> <span class="n">_bmp</span><span class="p">.</span><span class="nf">GetPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
     <span class="p">}</span>
<span class="p">}</span></code></pre>
</figure>

<h3>Pros</h3>
<ul>
  <li>Code is more readable.</li>
  <li>Easy to implement and use.</li>
</ul>
<h3>Cons</h3>
<p>-Low efficiency.</p>
<p align="justify">This method is really great for simple graphical operations when speed isn’t important. In my scenario with the <strong>Seam Carving</strong> algorithm, I had an <strong>efficiency</strong> problem using this method. <strong>Seam Carving</strong> algorithm is making a lot of calculations in order to find seams. The time is growing exponentially with the size of the image.</p>
<p align="justify"></p>

<h2>GDI+ and LockBits.</h2>
<p align="justify">Bitmap class contains two methods <strong>LockBits</strong> and <strong>UnlockBits</strong> , with them, we can get access and work directly on the memory. <strong>LockBits</strong> method returns <strong>BitmapData</strong> object, which is used to describe the memory sector. In this method, we have to use the pointers. That’s why our class should have an unsafe keyword.</p>

<p align="justify"></p>
<p align="justify">With BitmapData object we need to define some variables.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="kt">int</span> <span class="n">_pixelSize</span> <span class="p">=</span><span class="m">3</span><span class="p">;</span>
<span class="kt">byte</span><span class="p">*</span> <span class="n">_current</span> <span class="p">=(</span><span class="kt">byte</span><span class="p">*)(</span><span class="k">void</span><span class="p">*)</span><span class="n">_bmd</span><span class="p">.</span><span class="n">Scan0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">_nWidth</span> <span class="p">=</span> <span class="n">_bmp</span><span class="p">.</span><span class="n">Width</span> <span class="p">*</span> <span class="n">_pixelSize</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">_nHeight</span> <span class="p">=</span> <span class="n">_bmp</span><span class="p">.</span><span class="n">Height</span><span class="p">;</span></code></pre>
</figure>

<ul>
  <li>ScanO memory address which defines the beginning of our Bitmap</li>
  <li>_nWidth how many bots in one row
With this we can iterate through the image.</li>
</ul>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">y</span> <span class="p">&lt;</span> <span class="n">_nHeight</span><span class="p">;</span> <span class="n">y</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="n">_nWidth</span><span class="p">;</span><span class="n">x</span><span class="p">++</span> <span class="p">)</span>
    <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">%</span> <span class="n">_pixelSize</span> <span class="p">==</span><span class="m">0</span><span class="p">||</span> <span class="n">x</span> <span class="p">==</span><span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
             <span class="nf">SetColor</span><span class="p">(</span><span class="k">new</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="n">_current</span><span class="p">++;</span>
     <span class="p">}</span>
<span class="p">}</span></code></pre>
</figure>

<p align="justify">We have to remember that current variable is only a pointer  to a memory address</p>

<p align="justify">This condition ensures that the current will always point to the beginning of the next pixel. In my example pixel is represented by  three bytes, this value is stored in the _pixelSize variable.</p>
<p>With _current pointer we can access pixel values by using the indexer.</p>

<figure class="highlight">
  <pre><code class="language-csharp" data-lang="csharp"><span class="k">void</span> <span class="nf">SetColor</span><span class="p">(,</span><span class="n">Color</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
     <span class="n">_current</span><span class="p">[</span><span class="m">0</span><span class="p">]=</span> <span class="n">color</span><span class="p">.</span><span class="n">R</span><span class="p">;</span>
     <span class="n">_current</span> <span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">color</span><span class="p">.</span><span class="n">G</span><span class="p">;</span>
     <span class="n">_current</span> <span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">color</span><span class="p">.</span><span class="n">B</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</figure>

<h3>Pros:</h3>
<ul>
  <li>Speed</li>
</ul>
<h3>Cons:</h3>
<p align="justify">-Code is confusing but we can wrap the logic in readable functions</p>
<ul>
  <li>Implementation is complicated in the beginning</li>
</ul>
<p align="justify">- unmanaged code</p>

<h2>Comparision between Gdi+ Lockbits and GetPixel SetPixel</h2>
<table border="0" frame="VOID" rules="NONE" cellspacing="0"><colgroup><col width="86" /><col width="136" /><col width="149" /></colgroup>
<tbody>
<tr>
<td align="LEFT" width="86" height="18"></td>
<td align="LEFT" bgcolor="#CCCCCC" width="136">GDI+ LockBits (ms)</td>
<td align="LEFT" bgcolor="#CCCCCC" width="149">GetPixel SetPixel (ms)</td>
</tr>
<tr>
<td align="LEFT" bgcolor="#CCCCCC" height="18">Read Pixel</td>
<td align="RIGHT" bgcolor="#33CC66">21</td>
<td align="RIGHT">157</td>
</tr>
<tr>
<td align="LEFT" bgcolor="#CCCCCC" height="18">Write Pixel</td>
<td align="RIGHT" bgcolor="#33CC66">15</td>
<td align="RIGHT">153</td>
</tr>
<tr>
<td align="LEFT" bgcolor="#CCCCCC" height="18">Iterate Image</td>
<td align="RIGHT" bgcolor="#33CC66">226</td>
<td align="RIGHT">1496</td>
</tr>
</tbody>
</table>
<p align="justify"><a href="http://lammichalfranc.files.wordpress.com/2009/11/wykresikbmp1.jpg"><img class="alignnone size-full wp-image-55" title="wykresikBmp1" src="http://lammichalfranc.files.wordpress.com/2009/11/wykresikbmp1.jpg" alt="" width="450" height="278" /></a></p>
<p align="justify">As you can see the <strong>GDI</strong>+ <strong>Lockbits</strong> are almost seven times faster than <strong>GetPixel</strong> <strong>SetPixel</strong> method</p>
<p align="justify"><a href="https://www.assembla.com/code/projektyLM/subversion/nodes/SeamCarv"><strong>Link to the project.</strong></a></p>
<p> </p>

      <span id="post-end"></span>
    </div>

    <div id="mc_embed_signup">
<form action="https://mfranc.us13.list-manage.com/subscribe/post?u=8a5865e28c59044d419ecbe95&amp;id=d545f31150" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <label for="mce-EMAIL">If you are interested in Cloud Native, Scalability, System Design and more meaty side of Engineering at Scale. Then subscribe to my mailing list.</label>
      <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8a5865e28c59044d419ecbe95_d545f31150" tabindex="-1" value=""></div>
        <div class="clear">
          <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
        </div>
    </div>
</form>
</div>



    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
    <script>
      (function() {
        var d = document,
        s = d.createElement('script');
        s.src = '//thesilenceofthelams.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</aside>



  </div>

</article>

      </div>


      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="http://github.com/michal-franc" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="http://twitter.com/francmichal" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="http://facebook.com/michalfrancblog" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="https://uk.linkedin.com/in/michalfranc1" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>

    <p class="txt-medium-gray">
      <small>&copy;2018 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.slick-modals.js"/></script>

	  <!-- <script id="ulp-remote" src="http://tools.mfranc.com/wp-content/plugins/layered-popups/js/remote.min.js?ver=5.89" data-handler="http://tools.mfranc.com/wp-admin/admin-ajax.php"></script>
	  <script>

		    (function ($) {
			"use strict";
			var objectPositionTop = $('#post-end').offset().top - window.innerHeight;

				ulp_add_event("onexit", {
					popup:		"4AXWiVSrZD71uqiP",
					mode:		"once-period",
					period:		30
				});

				ulp_add_event("onidle", {
					popup:		"85oltSbndJGZQzaW",
					mode:		"once-period",
					period:         30
				});

				ulp_add_event("onscroll", {
					popup:		"INyhHrwTzxjvcqEb",
					mode:		"once-period",
					period:         30,
					offset:		objectPositionTop / 2
				});

		    }(jQuery));

    </script> -->

		<script id="dsq-count-scr" src="//thesilenceofthelams.disqus.com/count.js" async></script>

		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.7&appId=125980610784627";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
    </main>
  </body>
</html>
